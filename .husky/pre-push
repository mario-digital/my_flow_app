#!/usr/bin/env sh

echo "ğŸ§ª Running pre-push checks..."

# Git hygiene checks
if git ls-files --error-unmatch .env >/dev/null 2>&1; then
  echo "âŒ Detected tracked .env file. Remove it before pushing."
  exit 1
fi

# Frontend checks
echo "ğŸ” Linting frontend..."
(cd my_flow_client && bun run lint) || { echo "âŒ Frontend linting failed"; exit 1; }

echo "ğŸ“ Type checking frontend..."
(cd my_flow_client && bun run typecheck) || { echo "âŒ Frontend type check failed"; exit 1; }

echo "ğŸ”¬ Running frontend tests..."
bun --cwd my_flow_client test || { echo "âŒ Frontend tests failed"; exit 1; }

# Production build check with secrets (if 1Password CLI is available)
if command -v op >/dev/null 2>&1; then
  echo "ğŸ—ï¸ Building frontend with injected secrets..."
  (cd my_flow_client && op run --env-file=../.env.template -- bun run build) || {
    echo "âŒ Frontend build failed";
    exit 1;
  }
else
  echo "âš ï¸ Skipping secret-injected frontend build (1Password CLI not detected)."
  echo "   Install 1Password CLI and sign in to run the production build before pushing."
fi

# Backend checks
echo "ğŸ Linting backend..."
(cd my_flow_api && uv run ruff check .) || { echo "âŒ Backend linting failed"; exit 1; }

echo "ğŸ Type checking backend..."
(cd my_flow_api && uv run mypy src/) || { echo "âŒ Backend type check failed"; exit 1; }

echo "ğŸ Running backend tests..."
./scripts/run_backend_tests.sh || { echo "âŒ Backend tests failed"; exit 1; }

echo "âœ… All checks passed! Pushing..."
