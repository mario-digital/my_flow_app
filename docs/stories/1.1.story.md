# Story 1.1: Project Structure, Git Setup & 1Password CLI Integration

## Status
Approved

## Story
**As a** developer,
**I want** a complete project structure with Git, environment templates, and 1Password CLI secret management,
**so that** both frontend and backend teams can work securely without committing secrets to version control.

## Acceptance Criteria
1. Monorepo structure created with `/my_flow_api` and `/my_flow_client` directories
2. Git repository initialized with proper `.gitignore` (excludes `.env`, `.env.*`, `node_modules/`, `__pycache__/`, etc.)
3. README.md files created for root, `/my_flow_api`, and `/my_flow_client` with setup instructions
4. Backend dependencies initialized: `poetry init` or `uv init` with FastAPI, Pydantic, Motor, pytest, mypy
5. Frontend dependencies initialized: `bun create next-app` with TypeScript, Tailwind CSS, shadcn/ui CLI configured
6. **1Password CLI installed and configured for all environments:**
   - 1Password vault created with name "MyFlow Development"
   - Items created for: Logto (backend), Logto (frontend), MongoDB connection, OpenAI/Anthropic API keys
   - Template files created: `.env.template` (documents required variables without actual secrets)
7. **1Password CLI (`op`) configured for secret management:**
   - 1Password vault created: "MyFlow Development" with items for each environment
   - Template files created: `.env.template` (documents required variables, no actual secrets)
   - Scripts created: `scripts/load-secrets.sh`
   - Example: `op run --env-file=.env.template -- bun dev` to run with injected secrets
8. Both projects run locally with 1Password secret injection: `op run -- bun dev` (frontend on :3000), `op run -- uvicorn main:app --reload` (backend on :8000)

## Tasks / Subtasks

- [x] **Task 1: Create Feature Branch** (AC: N/A - Development Workflow)
  - [x] Create new branch from main: `git checkout -b story-1-1-project-structure`
  - [x] Verify branch creation: `git branch` should show current branch as `story-1-1-project-structure`
  - [x] All subsequent work should be done on this branch

- [x] **Task 2: Verify and Complete Monorepo Structure** (AC: 1)
  - [x] Verify root directory `my_flow_app/` exists (already created)
  - [x] Create subdirectories: `my_flow_client/`, `my_flow_api/`, `scripts/`
  - [x] Verify `.github/workflows/` exists (already present at root)
  - [x] Verify `docs/` directory exists (already contains PRD and architecture)
  - [x] Verify and update `.gitignore` in root - ensure it includes patterns from architecture spec (file already exists, add any missing patterns)
  - [x] Verify Git repository is initialized (already initialized)

- [x] **Task 3: Initialize Backend with uv** (AC: 4)
  - [x] Navigate to `my_flow_api/` directory
  - [x] Run `uv init` to initialize project with Python 3.12+ requirement
  - [x] Add dependencies via `uv add`: fastapi, pydantic, motor, uvicorn[standard]
  - [x] Add dev dependencies via `uv add --dev`: pytest, pytest-asyncio, pytest-cov, mypy, ruff
  - [x] Verify `pyproject.toml` was created with correct dependencies
  - [x] Create `src/` directory structure: `main.py`, `config.py`, `database.py`, `models/`, `routers/`, `services/`, `repositories/`, `middleware/`, `adapters/`
  - [x] Create `tests/` directory structure: `unit/`, `integration/`, `conftest.py`
  - [x] Create `pytest.ini` with test configuration
  - [x] Verify uv environment: `uv run python --version` should show Python 3.12+

- [x] **Task 4: Initialize Frontend with Bun + Next.js** (AC: 5)
  - [x] Run `bun create next-app my_flow_client` with TypeScript and Tailwind CSS
  - [x] Configure Next.js 15 with App Router in `next.config.js`
  - [x] Install shadcn/ui CLI: `bunx shadcn@latest init`
  - [x] Configure `components.json` for shadcn/ui with import alias `@/components`
  - [x] Update `tsconfig.json` with strict mode and path aliases
  - [x] Create `src/` directory structure: `app/`, `components/`, `lib/`, `hooks/`, `types/`, `styles/`
  - [x] Configure Tailwind CSS in `tailwind.config.ts` to consume CSS custom properties
  - [x] **Configure ESLint:**
    - [x] Verify `eslint.config.mjs` or `.eslintrc.json` exists (created by Next.js)
    - [x] Add Next.js recommended config and accessibility plugin (eslint-plugin-jsx-a11y)
    - [x] Configure import order rules for consistent imports
  - [x] **Configure Prettier:**
    - [x] Install Prettier: `bun add -d prettier`
    - [x] Create `.prettierrc` with settings: semi: true, singleQuote: true, tabWidth: 2, trailingComma: 'es5'
    - [x] Create `.prettierignore` with patterns: `.next/`, `node_modules/`, `dist/`, `build/`
    - [x] Install eslint-config-prettier: `bun add -d eslint-config-prettier` to avoid conflicts
    - [x] Add format script to `package.json`: `"format": "prettier --write \"src/**/*.{ts,tsx,js,jsx,json,css,md}\"` and `"format:check": "prettier --check \"src/**/*.{ts,tsx,js,jsx,json,css,md}\""`

- [x] **Task 5: Configure Root Workspace** (AC: 1)
  - [x] Create root `package.json` with Bun workspaces configuration
  - [x] Add workspace paths: `["my_flow_client", "packages/*"]`
  - [x] Add convenience scripts using `uv run` for backend: `dev`, `dev:frontend`, `dev:backend`, `test`, `lint`, `format`, `typecheck`, `build`
  - [x] Create root `bun.lockb` by running `bun install`

- [x] **Task 6: Create Documentation** (AC: 3)
  - [x] Create root `README.md` with:
    - Project overview and architecture diagram reference
    - Prerequisites (Bun 1.x, Python 3.12+, uv, 1Password CLI, MongoDB Atlas)
    - Quick start guide: `bun install`, `cd my_flow_api && uv sync`, `op run -- bun run dev`
    - Directory structure overview
    - Link to `docs/architecture/` for detailed docs
  - [x] Create `my_flow_client/README.md` with:
    - Frontend-specific setup instructions
    - Available scripts: `bun dev`, `bun test`, `bun lint`, `bun build`
    - Environment variable documentation
    - shadcn/ui component usage examples
  - [x] Create `my_flow_api/README.md` with:
    - Backend-specific setup instructions
    - Available scripts: `uv run uvicorn src.main:app --reload`, `uv run pytest`
    - API documentation reference (OpenAPI at `/docs`)
    - Database setup instructions
    - Note: Using `uv` for fast dependency management

- [x] **Task 7: Configure 1Password CLI Integration** (AC: 6, 7)
  - [x] Install 1Password CLI (`op`) on local machine (provide install instructions in README)
  - [x] Authenticate: `op signin`
  - [x] Create 1Password vault: `op vault create "MyFlow Development"`
  - [x] Create 1Password items with placeholders:
    - `op item create --category=login --title="MyFlow Logto Backend" --vault="MyFlow Development" --generate-password`
    - Add fields: LOGTO_ENDPOINT, LOGTO_APP_ID, LOGTO_APP_SECRET, LOGTO_RESOURCE
    - `op item create --category=login --title="MyFlow Logto Frontend" --vault="MyFlow Development"`
    - Add fields: NEXT_PUBLIC_LOGTO_ENDPOINT, NEXT_PUBLIC_LOGTO_APP_ID, LOGTO_APP_SECRET, LOGTO_COOKIE_SECRET
    - `op item create --category=login --title="MyFlow MongoDB" --vault="MyFlow Development"`
    - Add field: MONGODB_URI
    - `op item create --category=login --title="MyFlow AI Keys" --vault="MyFlow Development"`
    - Add fields: OPENAI_API_KEY, ANTHROPIC_API_KEY
  - [x] Create `.env.template` files in root, `my_flow_client/`, and `my_flow_api/` with 1Password secret references
  - [x] Create `scripts/load-secrets.sh` with `op run` wrapper examples

- [x] **Task 8: Verify and Update .gitignore** (AC: 2)
  - [x] Verify root `.gitignore` exists (already present)
  - [x] Ensure `.gitignore` includes required patterns (add if missing):
    - `.env`, `.env.*`, `!.env.template`, `!.env.example`
    - `node_modules/`, `bun.lockb` (keep lockfile for reproducibility)
    - `.next/`, `dist/`, `build/`
    - `__pycache__/`, `*.pyc`, `.pytest_cache/`, `.mypy_cache/`, `.ruff_cache/`
    - `uv.lock` should NOT be ignored (keep for reproducibility)
    - `coverage/`, `htmlcov/`, `.coverage`
    - `.DS_Store`, `.vscode/`, `.idea/`
    - `*.log`

- [x] **Task 9: Verify Local Development Setup** (AC: 8)
  - [x] Start backend: `cd my_flow_api && op run --env-file=../.env.template -- uv run uvicorn src.main:app --reload --host 0.0.0.0 --port 8000`
  - [x] Verify backend health check at `http://localhost:8000/api/v1/health` returns 200
  - [x] Start frontend: `cd my_flow_client && op run --env-file=../.env.template -- bun dev`
  - [x] Verify frontend loads at `http://localhost:3000` with default Next.js page
  - [x] Verify no secrets are committed to Git: `git status` should show no `.env` files

- [x] **Task 10: Unit Testing Setup** (AC: Testing requirements)
  - [x] Backend: Create sample test `tests/unit/test_main.py` that tests FastAPI app creation
  - [x] Backend: Run `uv run pytest` and verify tests pass
  - [x] Frontend: Create sample test `src/app/page.test.tsx` that renders default page
  - [x] Frontend: Run `bun test` and verify tests pass
  - [x] Verify test coverage meets 80% threshold (though minimal at this stage)

## Dev Notes

### Previous Story Insights
No previous stories exist - this is the first story in the project.

### Tech Stack
[Source: architecture/tech-stack.md]
- **Package Manager:** Bun 1.x (10x faster than npm, native TypeScript support)
- **Frontend:** Next.js 15.x with App Router, React 19.x, TypeScript 5.6+
- **Frontend UI:** shadcn/ui (Radix UI primitives), Tailwind CSS 4.x
- **Backend:** Python 3.12+, FastAPI 0.115.x+, Motor 3.x (async MongoDB)
- **Database:** MongoDB 7.x+ (free tier, 512MB)
- **Auth:** Logto (cloud SaaS, OAuth 2.0, JWT tokens)
- **Secrets:** 1Password CLI (`op`) for environment variable injection
- **Testing:** Vitest (frontend), pytest (backend), Playwright (E2E)
- **Linting:** ESLint (frontend), Ruff (backend)
- **Type Checking:** TypeScript Compiler 5.6+ (frontend), mypy (backend)
- **Dependency Management:** uv (backend - fast Python package manager, already installed on dev machine)

### Project Structure
[Source: architecture/9-unified-project-structure.md]

**Root Directory Structure:**
```
my_flow_app/                      # Root monorepo directory
├── .github/workflows/            # CI/CD pipelines (added in later stories)
├── my_flow_client/               # Next.js 15 frontend
│   ├── src/
│   │   ├── app/                  # App Router pages
│   │   ├── components/           # React components (Server + Client)
│   │   ├── lib/                  # Utilities, API client, hooks
│   │   └── styles/               # CSS tokens, Tailwind config
│   ├── public/                   # Static assets
│   ├── package.json              # Frontend dependencies
│   ├── tsconfig.json             # TypeScript configuration
│   ├── tailwind.config.ts        # Tailwind consuming CSS tokens
│   └── next.config.js            # Next.js configuration
├── my_flow_api/                  # FastAPI backend
│   ├── src/
│   │   ├── main.py               # FastAPI entry point
│   │   ├── config.py             # Pydantic Settings
│   │   ├── database.py           # MongoDB connection (placeholder for now)
│   │   ├── models/               # Pydantic schemas
│   │   ├── routers/              # FastAPI routers
│   │   ├── services/             # Business logic layer
│   │   ├── repositories/         # Data access layer
│   │   ├── middleware/           # Auth, logging middleware
│   │   └── adapters/             # External service integrations
│   ├── tests/
│   │   ├── unit/                 # Unit tests
│   │   ├── integration/          # Integration tests
│   │   └── conftest.py           # Pytest fixtures
│   ├── pyproject.toml            # uv dependencies and configuration
│   ├── uv.lock                   # uv lockfile for reproducible builds
│   └── Dockerfile                # Production image (added in Story 1.8)
├── docs/                         # Project documentation (already exists)
├── scripts/                      # Utility scripts
│   └── load-secrets.sh           # 1Password secret loading helper
├── package.json                  # Root workspace configuration
├── bun.lockb                     # Bun lockfile
├── .gitignore                    # Git ignore patterns
├── .env.template                 # Environment variable template
└── README.md                     # Project overview
```

**Root package.json Scripts:**
```json
{
  "scripts": {
    "dev:frontend": "cd my_flow_client && bun run dev",
    "dev:backend": "cd my_flow_api && uv run uvicorn src.main:app --reload --host 0.0.0.0 --port 8000",
    "dev": "bun run dev:backend & bun run dev:frontend",
    "build:frontend": "cd my_flow_client && bun run build",
    "build:backend": "cd my_flow_api && docker build -t my-flow-api .",
    "test:frontend": "cd my_flow_client && bun test",
    "test:backend": "cd my_flow_api && uv run pytest",
    "test": "bun run test:frontend && bun run test:backend",
    "lint:frontend": "cd my_flow_client && bun run lint",
    "lint:backend": "cd my_flow_api && uv run ruff check src/",
    "lint": "bun run lint:frontend && bun run lint:backend",
    "format:frontend": "cd my_flow_client && bun run format",
    "format:backend": "cd my_flow_api && uv run ruff format src/",
    "format": "bun run format:frontend && bun run format:backend",
    "typecheck:frontend": "cd my_flow_client && bun run typecheck",
    "typecheck:backend": "cd my_flow_api && uv run mypy src/",
    "typecheck": "bun run typecheck:frontend && bun run typecheck:backend"
  }
}
```

### Environment Variables
[Source: architecture/9-unified-project-structure.md]

**.env.template (Root):**
```bash
# Frontend (.env.local in my_flow_client/)
NEXT_PUBLIC_API_URL=http://localhost:8000
NEXT_PUBLIC_LOGTO_ENDPOINT=op://MyFlow Development/MyFlow Logto Frontend/NEXT_PUBLIC_LOGTO_ENDPOINT
NEXT_PUBLIC_LOGTO_APP_ID=op://MyFlow Development/MyFlow Logto Frontend/NEXT_PUBLIC_LOGTO_APP_ID
LOGTO_APP_SECRET=op://MyFlow Development/MyFlow Logto Frontend/LOGTO_APP_SECRET
LOGTO_COOKIE_SECRET=op://MyFlow Development/MyFlow Logto Frontend/LOGTO_COOKIE_SECRET

# Backend (.env in my_flow_api/)
MONGODB_URI=op://MyFlow Development/MyFlow MongoDB/MONGODB_URI
LOGTO_ENDPOINT=op://MyFlow Development/MyFlow Logto Backend/LOGTO_ENDPOINT
LOGTO_APP_ID=op://MyFlow Development/MyFlow Logto Backend/LOGTO_APP_ID
LOGTO_APP_SECRET=op://MyFlow Development/MyFlow Logto Backend/LOGTO_APP_SECRET
LOGTO_RESOURCE=op://MyFlow Development/MyFlow Logto Backend/LOGTO_RESOURCE
CORS_ORIGINS=["http://localhost:3000","https://yourdomain.com"]
OPENAI_API_KEY=op://MyFlow Development/MyFlow AI Keys/OPENAI_API_KEY
ANTHROPIC_API_KEY=op://MyFlow Development/MyFlow AI Keys/ANTHROPIC_API_KEY
```

### 1Password CLI Usage
[Source: Epic 1 Story 1.1 AC 7]

**Installation:**
- macOS: `brew install 1password-cli`
- Linux: Follow instructions at https://developer.1password.com/docs/cli/get-started/
- Windows: Download from 1Password website

**Configuration:**
1. Authenticate: `op signin`
2. Create vault: `op vault create "MyFlow Development"`
3. Create items: `op item create --category=login --title="MyFlow Logto Backend" --vault="MyFlow Development"`
4. Add fields: `op item edit "MyFlow Logto Backend" LOGTO_ENDPOINT=placeholder`

**Usage Pattern:**
- Run with secrets: `op run --env-file=.env.template -- <command>`
- Example: `op run --env-file=.env.template -- bun dev`
- Scripts can wrap `op run` for convenience

### Coding Standards
[Source: architecture/14-coding-standards.md]

**File Organization:**
- Frontend: `kebab-case` for files, `PascalCase` for components
- Backend: `snake_case` for files and functions, `PascalCase` for classes
- Environment variables: `UPPER_SNAKE_CASE`
- Git files: `.gitignore` excludes all `.env*` files except `.env.template` and `.env.example`

**Import Order:**
- TypeScript: External deps → Internal (`@/`) → Relative → Styles
- Python: Standard library → Third-party → Local application

**Key Patterns:**
- Centralized config access (no direct `process.env` or `os.environ` access)
- Environment variable validation via Pydantic Settings (backend)
- Repository pattern for database access (prepare directory structure)

**Frontend Linting & Formatting:**
[Source: architecture/tech-stack.md]
- **ESLint:** Next.js config + accessibility rules (jsx-a11y)
- **Prettier:** Code formatter with consistent style
  - Settings: semi: true, singleQuote: true, tabWidth: 2, trailingComma: 'es5'
  - Integrates with ESLint via eslint-config-prettier
  - Auto-format on save recommended
- **Import Order:** Enforced via ESLint plugin or Prettier plugin

**Backend Linting & Formatting:**
[Source: architecture/tech-stack.md]
- **Ruff:** Fast Python linter (replaces Flake8 + Black)
  - 100x faster than traditional tools
  - Auto-fix capabilities
  - Includes formatter (Black-compatible style)

### Testing
[Source: architecture/13-testing-strategy.md]

**Frontend Testing:**
- Framework: Vitest with React Testing Library
- Test location: Co-located with components (`flow-card.test.tsx` next to `flow-card.tsx`)
- Configuration: `vitest.config.ts` with jsdom environment
- Coverage: 80% threshold (lines, functions, branches, statements)

**Backend Testing:**
- Framework: pytest with pytest-asyncio
- Test location: `tests/unit/`, `tests/integration/`, `tests/e2e/`
- Configuration: `pytest.ini` with async mode auto-enabled
- Coverage: 80% threshold via pytest-cov

**Initial Test Requirements:**
- Create minimal "hello world" tests to verify testing infrastructure works
- Backend: Test FastAPI app creation (`test_main.py`)
- Frontend: Test default page renders (`page.test.tsx`)
- Verify `bun test` and `poetry run pytest` commands execute successfully

### Technical Constraints
[Source: architecture/tech-stack.md, Epic 1 Story 1.1]

**Version Requirements:**
- Python: 3.12+ (required for modern type hints)
- TypeScript: 5.6+ (strict mode enabled)
- Node: Not used directly (Bun replaces Node)
- Bun: 1.x (native TypeScript, workspace support)

**Security Requirements:**
- **CRITICAL:** NO `.env` files in Git (only `.env.template` and `.env.example` allowed)
- All secrets must be stored in 1Password vault
- Use `op run` command for local development
- GitHub Actions will use 1Password service account (configured in Story 1.5)

**File Locations:**
- Frontend: `my_flow_client/` (Next.js 15 with App Router)
- Backend: `my_flow_api/` (FastAPI with Python 3.12+)
- Shared docs: `docs/` (architecture, PRD, stories)
- Scripts: `scripts/` (1Password helpers, deployment scripts)

### Project Structure Notes

**Alignment with Architecture:**
- Monorepo structure matches architecture spec exactly
- Bun workspaces configured for frontend + future shared packages
- Backend uses Poetry for deterministic builds
- Directory structure prepared for layered architecture (routers → services → repositories)

**Deviations:**
- None - this is the foundation story, so structure is being created from scratch per architecture spec

**Future Considerations:**
- `packages/shared-types/` directory prepared for future TypeScript type sharing (Epic 2+)
- `.github/workflows/` will be populated in Story 1.5 (CI/CD)
- Docker configurations will be added in Story 1.8 (Docker Compose)

## Testing

### Testing Standards
[Source: architecture/13-testing-strategy.md]

**Frontend Testing (Vitest):**
- Test files: `*.test.tsx` or `*.test.ts` co-located with source
- Framework: Vitest with React Testing Library
- Environment: jsdom
- Coverage: 80% threshold (lines, functions, branches, statements)
- Run command: `bun test`
- Configuration file: `vitest.config.ts`

**Backend Testing (pytest):**
- Test files: `test_*.py` in `tests/unit/`, `tests/integration/`
- Framework: pytest with pytest-asyncio
- Coverage: 80% threshold via pytest-cov
- Run command: `poetry run pytest`
- Configuration file: `pytest.ini`
- Markers: `@pytest.mark.unit`, `@pytest.mark.integration`

**Minimum Tests Required for Story 1.1:**
1. Backend: Create `tests/unit/test_main.py` with test for FastAPI app instantiation
2. Frontend: Create `src/app/page.test.tsx` with test for default page render
3. Verify both test suites run successfully with `bun test` and `poetry run pytest`
4. Initial coverage will be low - focus is on infrastructure setup, not comprehensive testing

**Test Configuration:**
- Frontend `vitest.config.ts` must include:
  - `environment: 'jsdom'`
  - Path aliases matching `tsconfig.json` (`@/` → `./src`)
  - Coverage provider: `v8`
  - Coverage thresholds: 80% (will be enforced in later stories)
- Backend `pytest.ini` must include:
  - `asyncio_mode = auto`
  - `testpaths = tests`
  - Coverage flags: `--cov=src --cov-report=term-missing --cov-fail-under=80`

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-09-30 | 1.0 | Initial story draft created | Scrum Master (Bob) |
| 2025-09-30 | 1.1 | Updated to use `uv` instead of Poetry for backend dependency management (dev machine already has uv installed) | Scrum Master (Bob) |
| 2025-09-30 | 1.2 | Clarified Task 1 and Task 7 to verify existing files (.gitignore, directories) rather than create from scratch | Scrum Master (Bob) |
| 2025-09-30 | 1.3 | Added ESLint and Prettier configuration to Task 4 with detailed setup instructions and root format scripts | Scrum Master (Bob) |
| 2025-09-30 | 1.4 | Added Task 1: Create Feature Branch (story-1.1-project-structure) and renumbered all subsequent tasks | Scrum Master (Bob) |
| 2025-09-30 | 1.5 | Story validated and approved - Ready for Dev Agent implementation (Validation Score: 9.5/10) | Scrum Master (Bob) |

## Dev Agent Record

*This section will be populated by the development agent during implementation.*

### Agent Model Used

*To be filled by Dev Agent*

### Debug Log References

*To be filled by Dev Agent*

### Completion Notes List

*To be filled by Dev Agent*

### File List

*To be filled by Dev Agent*

## QA Results

*This section will be populated by the QA Agent after story completion.*