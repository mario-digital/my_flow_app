# Story 2.5: Context Switcher UI Component (FE)

## Status
Draft

## Story

**As a** frontend developer,
**I want** a reusable Context Switcher component built with shadcn/ui,
**so that** users can easily switch between contexts with visual distinction.

## Acceptance Criteria

1. **Context Switcher component created in `my_flow_client/src/components/contexts/context-switcher.tsx`:**
   - Uses shadcn/ui `Select` component as base
   - Displays context name, icon (emoji), and color indicator
   - Shows current context with visual highlight
   - Dropdown shows all user contexts sorted by most recently used

2. **Styling uses Tailwind utility classes mapped to CSS design tokens:**
   - Context colors use `bg-context`, `bg-context-work`, `bg-context-personal`, etc.
   - Background colors use `bg-bg-secondary`
   - Text colors use `text-text-primary` and `text-text-secondary`
   - Spacing uses `space-md` and `space-sm` from Tailwind config
   - No hardcoded colors or spacing values (use Tailwind utilities only)

3. **Component props typed with TypeScript:**
   ```typescript
   interface ContextSwitcherProps {
     currentContextId: string;
     contexts: Context[];
     onContextChange: (contextId: string) => void;
     className?: string;
   }
   ```

4. **Accessibility requirements met:**
   - Keyboard navigable (Tab, Enter, Arrow keys)
   - Screen reader labels for all interactive elements
   - Focus states visible with context accent color border
   - ARIA attributes: `role="combobox"`, `aria-label="Select context"`

5. **Unit tests created in `my_flow_client/src/components/contexts/__tests__/context-switcher.test.tsx`:**
   - Tests rendering with mock context data
   - Tests keyboard navigation
   - Tests `onContextChange` callback firing
   - Tests accessibility with jest-axe
   - At least 80% coverage

6. **Storybook story created in `my_flow_client/src/components/contexts/context-switcher.stories.tsx` (Optional):**
   - Shows component with 4 contexts (work, personal, rest, social)
   - Shows selected state
   - Shows disabled state
   - Dark mode only (no light mode variant)

## Tasks / Subtasks

- [ ] **Task 1: Install and configure shadcn/ui Select component** (AC: 1)
  - [ ] Check if shadcn/ui is already initialized in the project
  - [ ] Run `npx shadcn@latest add select` to add Select component
  - [ ] Verify Select component installed at `src/components/ui/select.tsx`

- [ ] **Task 2: Create component directory and files** (AC: 1, 3)
  - [ ] Create directory: `my_flow_client/src/components/contexts/`
  - [ ] Create file: `context-switcher.tsx`
  - [ ] Create test directory: `__tests__/`
  - [ ] Create test file: `__tests__/context-switcher.test.tsx`

- [ ] **Task 3: Define TypeScript interfaces** (AC: 3)
  - [ ] Create `Context` type in `src/types/context.ts` (if not exists)
  - [ ] Define fields: id (string), user_id (string), name (string), color (string), icon (string), created_at (string), updated_at (string)
  - [ ] Create `ContextSwitcherProps` interface in component file
  - [ ] Import and use proper types for all props and state

- [ ] **Task 4: Implement basic Context Switcher component** (AC: 1, 2)
  - [ ] Create functional component with shadcn/ui Select as base
  - [ ] Accept props: currentContextId, contexts, onContextChange, className
  - [ ] Render Select.Trigger showing current context name and icon
  - [ ] Render Select.Content with all contexts as Select.Items
  - [ ] Display context icon (emoji), name, and color indicator for each item
  - [ ] Apply Tailwind utility classes ONLY (no `[var(--*)]` arbitrary values)
  - [ ] Use `bg-bg-secondary`, `text-text-primary`, `text-text-secondary` from Tailwind config
  - [ ] Add color indicator using `bg-context-work`, `bg-context-personal`, etc.

- [ ] **Task 5: Implement context sorting logic** (AC: 1)
  - [ ] Sort contexts by `updated_at` descending (most recently used first)
  - [ ] Ensure current context is visually highlighted in dropdown
  - [ ] Add visual separator or "Current" label for selected context

- [ ] **Task 6: Implement accessibility features** (AC: 4)
  - [ ] Add `role="combobox"` to Select component (may be default from shadcn/ui)
  - [ ] Add `aria-label="Select context"` to Select.Trigger
  - [ ] Add `aria-current="true"` to current context Select.Item
  - [ ] Ensure keyboard navigation works: Tab (focus), Enter (open/select), Arrow keys (navigate)
  - [ ] Add focus-visible ring using `ring-context` or `ring-2 ring-offset-2 ring-context`
  - [ ] Test with keyboard only (no mouse) to verify full navigability

- [ ] **Task 7: Write unit tests** (AC: 5)
  - [ ] Install testing dependencies if needed: `@testing-library/react`, `@testing-library/user-event`, `vitest`
  - [ ] Create test file with mock context data (4 contexts: work, personal, rest, social)
  - [ ] Test: Component renders correctly with contexts
  - [ ] Test: Current context is displayed in trigger
  - [ ] Test: Clicking trigger opens dropdown with all contexts
  - [ ] Test: Clicking a context calls `onContextChange` with correct ID
  - [ ] Test: Keyboard navigation (ArrowDown, ArrowUp, Enter) works
  - [ ] Test: Component has accessible labels and roles
  - [ ] Install and configure `jest-axe` for accessibility testing
  - [ ] Test: No accessibility violations detected by jest-axe
  - [ ] Run coverage: `bun test --coverage` and verify 80%+ coverage

- [ ] **Task 8: Create Storybook story (Optional)** (AC: 6)
  - [ ] Check if Storybook is configured in project
  - [ ] Create `context-switcher.stories.tsx` file
  - [ ] Create story: "Default" with 4 contexts, "Work" selected
  - [ ] Create story: "Personal Context Selected"
  - [ ] Create story: "Disabled State" (if applicable)
  - [ ] Run `bun run storybook` and verify stories render correctly

- [ ] **Task 9: Integration test with mock data** (AC: 1, 2, 4)
  - [ ] Create integration test that renders component with full context list
  - [ ] Verify color indicators match context colors
  - [ ] Verify sorting is correct (most recent first)
  - [ ] Verify aria attributes are present
  - [ ] Verify callback is invoked with correct parameters

## Dev Notes

### Testing Standards

**Test file locations:**
- Component tests: `my_flow_client/src/components/contexts/__tests__/`
- Test file naming: `<component-name>.test.tsx` (e.g., `context-switcher.test.tsx`)

**Testing frameworks:**
- Vitest for test runner (configured as Bun Test alternative)
- React Testing Library (`@testing-library/react`) for component testing
- `@testing-library/user-event` for user interaction simulation
- `jest-axe` for accessibility testing

**Testing requirements:**
- 80% minimum coverage for component files
- Test rendering, user interactions, callbacks, and accessibility
- Use `screen.getByRole()` queries for accessibility-focused tests

[Source: docs/architecture/13-testing-strategy.md#frontend-tests]

### Component Architecture

**Component type:**
- **Client Component** - Requires `'use client'` directive
- Reason: Interactive state management (dropdown open/close, selection)
- File should start with `'use client';` at the very top

**Component location:**
```
my_flow_client/src/components/contexts/
‚îú‚îÄ‚îÄ context-switcher.tsx        # Client Component
‚îî‚îÄ‚îÄ __tests__/
    ‚îî‚îÄ‚îÄ context-switcher.test.tsx
```

[Source: docs/architecture/frontend-architecture.md#component-organization, docs/architecture/components.md#2-context-switcher-client-component]

### Context Data Model

**Context interface (TypeScript):**
```typescript
interface Context {
  id: string;              // MongoDB ObjectId
  user_id: string;         // Logto user ID
  name: string;            // Display name (1-50 chars)
  color: string;           // Hex color (#RRGGBB)
  icon: string;            // Emoji character
  created_at: string;      // ISO 8601 datetime
  updated_at: string;      // ISO 8601 datetime
}
```

**Example context data:**
```typescript
const mockContexts: Context[] = [
  {
    id: "ctx-work-123",
    user_id: "user-1",
    name: "Work",
    color: "#3B82F6",
    icon: "üíº",
    created_at: "2025-10-01T10:00:00Z",
    updated_at: "2025-10-05T14:30:00Z"
  },
  {
    id: "ctx-personal-456",
    user_id: "user-1",
    name: "Personal",
    color: "#F97316",
    icon: "üè†",
    created_at: "2025-10-01T10:05:00Z",
    updated_at: "2025-10-04T09:15:00Z"
  }
];
```

[Source: docs/architecture/data-models.md#context-model]

### Tailwind CSS Variable Usage (CRITICAL)

**MANDATORY: Use Tailwind utility classes, NOT arbitrary value syntax**

The project uses a centralized Tailwind configuration that maps CSS custom properties to utility classes. You MUST use these utilities.

**CORRECT approach (40-50% shorter):**
```tsx
<div className="bg-bg-primary text-text-primary border-border">
  <button className="bg-button-primary text-button-text-primary shadow-sm">
    Click Me
  </button>
</div>
```

**WRONG approach (verbose, avoid this):**
```tsx
<div className="bg-[var(--color-bg-primary)] text-[var(--color-text-primary)] border-[var(--color-border)]">
  <button className="bg-[var(--button-bg-primary)] text-[var(--button-text-primary)] shadow-[var(--shadow-sm)]">
    Click Me
  </button>
</div>
```

**Available Tailwind utilities for this component:**
- Backgrounds: `bg-bg-primary`, `bg-bg-secondary`, `bg-bg-tertiary`
- Text: `text-text-primary`, `text-text-secondary`, `text-text-muted`
- Borders: `border-border`, `border-card-border`
- Context colors: `bg-context`, `text-context`, `border-context`
- Specific contexts: `bg-context-work`, `bg-context-personal`, `bg-context-rest`, `bg-context-social`
- Buttons: `bg-button-primary`, `text-button-text-primary`
- Cards: `bg-card`, `border-card-border`
- Shadows: `shadow-sm`, `shadow-md`, `shadow-lg`

All mappings defined in `my_flow_client/src/app/globals.css` in the `@theme` block.

[Source: docs/architecture/coding-standards.md#8-tailwind-css-variable-usage]

### shadcn/ui Select Component

**Installation:**
```bash
npx shadcn@latest add select
```

**Basic usage pattern:**
```tsx
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from "@/components/ui/select"

<Select value={value} onValueChange={setValue}>
  <SelectTrigger className="w-[200px]">
    <SelectValue placeholder="Select option" />
  </SelectTrigger>
  <SelectContent>
    <SelectItem value="option1">Option 1</SelectItem>
    <SelectItem value="option2">Option 2</SelectItem>
  </SelectContent>
</Select>
```

**Accessibility:**
- shadcn/ui Select is built on Radix UI Primitives
- Automatically includes ARIA attributes: `role="combobox"`, `aria-expanded`, `aria-controls`
- Keyboard navigation built-in: Tab, Enter, Arrow keys, Escape

[Source: shadcn/ui documentation, docs/architecture/tech-stack.md]

### Accessibility Requirements

**Keyboard navigation:**
- `Tab`: Focus on Select component
- `Enter` or `Space`: Open dropdown
- `ArrowDown` / `ArrowUp`: Navigate through options
- `Enter`: Select highlighted option
- `Escape`: Close dropdown

**Screen reader support:**
- `aria-label="Select context"` on SelectTrigger
- `aria-current="true"` on current context item
- Semantic HTML roles (SelectTrigger uses `button` role, SelectContent uses `listbox`)

**Focus states:**
- Visible focus ring using `ring-2 ring-context` or similar
- Focus should use context accent color to match current theme

[Source: docs/architecture/frontend-architecture.md#accessibility-considerations]

### Import Order Standards

```tsx
// 1. External dependencies
import { useState } from 'react';
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select';

// 2. Internal absolute imports (@/ alias)
import { cn } from '@/lib/utils';
import type { Context } from '@/types/context';

// 3. Relative imports
import './context-switcher.css'; // if needed
```

[Source: docs/architecture/coding-standards.md#import-order-standards]

### Component Implementation Pattern

**File structure:**
```tsx
'use client';

import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select';
import type { Context } from '@/types/context';
import { cn } from '@/lib/utils';

interface ContextSwitcherProps {
  currentContextId: string;
  contexts: Context[];
  onContextChange: (contextId: string) => void;
  className?: string;
}

export function ContextSwitcher({
  currentContextId,
  contexts,
  onContextChange,
  className
}: ContextSwitcherProps) {
  // Sort contexts by updated_at descending
  const sortedContexts = [...contexts].sort((a, b) =>
    new Date(b.updated_at).getTime() - new Date(a.updated_at).getTime()
  );

  const currentContext = contexts.find(c => c.id === currentContextId);

  return (
    <Select value={currentContextId} onValueChange={onContextChange}>
      <SelectTrigger
        className={cn("w-[200px]", className)}
        aria-label="Select context"
      >
        <SelectValue>
          {currentContext && (
            <div className="flex items-center gap-2">
              <span className="text-lg">{currentContext.icon}</span>
              <span className="text-text-primary">{currentContext.name}</span>
              <div
                className="w-3 h-3 rounded-full"
                style={{ backgroundColor: currentContext.color }}
              />
            </div>
          )}
        </SelectValue>
      </SelectTrigger>
      <SelectContent className="bg-bg-secondary border-border">
        {sortedContexts.map((context) => (
          <SelectItem
            key={context.id}
            value={context.id}
            aria-current={context.id === currentContextId ? 'true' : undefined}
            className="flex items-center gap-2 text-text-primary hover:bg-bg-tertiary"
          >
            <span className="text-lg">{context.icon}</span>
            <span>{context.name}</span>
            <div
              className="w-3 h-3 rounded-full ml-auto"
              style={{ backgroundColor: context.color }}
            />
          </SelectItem>
        ))}
      </SelectContent>
    </Select>
  );
}
```

**Note on color indicators:** The `backgroundColor: context.color` inline style is acceptable here because context colors are dynamic user data, not design tokens. For all other styling, use Tailwind utilities.

[Source: docs/architecture/components.md#2-context-switcher-client-component, docs/architecture/frontend-architecture.md#react-server-components-strategy]

### No Previous Story Context

This is the first frontend story in Epic 2, so no previous story insights to incorporate. However, Story 2.1 (Backend Pydantic Models) is a parallel dependency that defines the Context data structure.

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-05 | 1.0 | Story created for Epic 2.5 | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used
<!-- To be filled by dev agent -->

### Debug Log References
<!-- To be filled by dev agent -->

### Completion Notes List
<!-- To be filled by dev agent -->

### File List
<!-- To be filled by dev agent -->

## QA Results
<!-- To be filled by QA agent -->
