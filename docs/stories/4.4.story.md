# Story 4.4: Transition Suggestions UI (shadcn/ui)

## Status
Cancelled

## Story

**As a** frontend developer,
**I want** a UI component showing transition suggestions,
**so that** users see helpful reminders when switching contexts.

## Acceptance Criteria

1. **Suggestions component created in `my_flow_client/src/components/transitions/transition-suggestions.tsx`:**
   - Uses shadcn/ui `Dialog` or `Alert` component
   - Displays warnings, suggestions, and urgent flows
   - "Continue" button to proceed with switch
   - "View Flows" button to see details before switching

2. **Styling strictly follows `docs/ux-design-tokens/component-styling-guide.md`:**
   - **NOTE:** Border width tokens already configured in `my_flow_client/src/app/styles/tokens/effects.css`
   - ALL components use CSS design tokens via Tailwind utility classes
   - Dialog uses modal-specific tokens (`bg-modal-bg`, `border-modal-border`, `rounded-modal`)
   - Loading states use semantic skeleton tokens (`h-skeleton-*`, `w-skeleton-*`)
   - Typography uses semantic tokens (`text-tiny`, `text-small`, `text-base`, NOT Tailwind defaults)
   - Warning alerts use alert component tokens (`bg-alert-warning-bg`, `text-alert-warning-text`)
   - Urgent flows use semantic border tokens (`border-l-urgent border-l-error` for 3px red left border)
   - Buttons follow exact button specifications (primary for Continue, secondary for Cancel)
   - NO hardcoded hex values or arbitrary token syntax except documented exceptions
   - See Dev Notes > "Strict Component Styling Requirements" for complete specification

3. **Integration with Context Switcher:**
   - When user selects new context, fetch suggestions from API
   - Display dialog if warnings exist
   - Allow user to proceed or cancel switch

4. **Component props typed with TypeScript:**
   ```typescript
   interface TransitionSuggestionsProps {
     fromContext: Context;
     toContext: Context;
     suggestions: TransitionSuggestions;
     onContinue: () => void;
     onCancel: () => void;
   }
   ```

5. **Unit tests created in `my_flow_client/src/__tests__/components/transitions/transition-suggestions.test.tsx`:**
   - Tests rendering with mock suggestions
   - Tests "Continue" and "Cancel" actions
   - At least 80% coverage

6. **Storybook story created:**
   - Shows suggestions with 2 warnings and 3 urgent flows
   - Shows empty state (no warnings)
   - Dark mode only

## Tasks / Subtasks

- [ ] **Task 0: Review backend API contracts** (AC: 3)
  - [ ] Review Story 4.2: Transition Suggestions API
    - Endpoint: `GET /api/v1/transitions/suggestions?from={context_id}&to={context_id}`
    - Response: `TransitionSuggestions` with warnings, suggestions, urgent_flows
  - [ ] Review Story 4.3: Incomplete Flow Warnings API
    - Endpoint: `GET /api/v1/transitions/warnings/{context_id}`
    - Response: `IncompleteFlowWarning` with counts and overdue flows
  - [ ] Review existing Context Switcher component
    - File: `my_flow_client/src/components/contexts/context-switcher.tsx`
    - Understand context selection flow
    - Identify integration points for transition logic

- [ ] **Task 1: Create TypeScript types for transition data** (AC: 4)
  - [ ] Create `my_flow_client/src/types/transitions.ts`
  - [ ] Define `TransitionSuggestions` interface matching backend:
    ```typescript
    import type { Flow, Context } from './api';
    
    export interface TransitionSuggestions {
      from_context: string;
      to_context: string;
      warnings: string[];
      suggestions: string[];
      urgent_flows: Flow[];
    }
    
    export interface IncompleteFlowWarning {
      context_id: string;
      incomplete_count: number;
      overdue_count: number;
      overdue_flows: Flow[];
    }
    
    export interface TransitionSuggestionsProps {
      fromContext: Context;
      toContext: Context;
      suggestions: TransitionSuggestions;
      onContinue: () => void;
      onCancel: () => void;
      isLoading?: boolean;
    }
    ```
  - [ ] Export all types from this file
  - [ ] Add JSDoc comments for each interface

- [ ] **Task 2: Create Next.js BFF API route for transition suggestions** (AC: 3)
  - [ ] Create `my_flow_client/src/app/api/transitions/suggestions/route.ts`
  - [ ] Import required dependencies:
    ```typescript
    import { getApiAccessToken } from '@logto/next/server-actions';
    import { NextResponse } from 'next/server';
    ```
  - [ ] Implement GET handler:
    ```typescript
    export async function GET(request: Request) {
      try {
        // 1. Get JWT token server-side (never exposed to browser)
        const token = await getApiAccessToken();
        
        if (!token) {
          return NextResponse.json(
            { error: 'Unauthorized' },
            { status: 401 }
          );
        }
        
        // 2. Extract query params
        const { searchParams } = new URL(request.url);
        const fromContext = searchParams.get('from');
        const toContext = searchParams.get('to');
        
        if (!fromContext || !toContext) {
          return NextResponse.json(
            { error: 'Missing from or to parameter' },
            { status: 400 }
          );
        }
        
        // 3. Call FastAPI with JWT token
        const response = await fetch(
          `${process.env.API_BASE_URL}/api/v1/transitions/suggestions?from=${fromContext}&to=${toContext}`,
          {
            headers: {
              'Authorization': `Bearer ${token}`,
              'Content-Type': 'application/json',
            },
          }
        );
        
        if (!response.ok) {
          throw new Error(`Backend error: ${response.status}`);
        }
        
        // 4. Proxy response back to browser (without token)
        const data = await response.json();
        return NextResponse.json(data);
        
      } catch (error) {
        console.error('Transition suggestions proxy error:', error);
        return NextResponse.json(
          { error: 'Failed to fetch transition suggestions' },
          { status: 500 }
        );
      }
    }
    ```
  - [ ] Add error handling for network failures
  - [ ] Add validation for query parameters
  - [ ] Test route: `curl http://localhost:3000/api/transitions/suggestions?from=ctx1&to=ctx2`

- [ ] **Task 3: Create Next.js BFF API route for warnings** (AC: 3)
  - [ ] Create `my_flow_client/src/app/api/transitions/warnings/[context_id]/route.ts`
  - [ ] Import required dependencies:
    ```typescript
    import { getApiAccessToken } from '@logto/next/server-actions';
    import { NextResponse } from 'next/server';
    ```
  - [ ] Implement GET handler:
    ```typescript
    export async function GET(
      request: Request,
      { params }: { params: { context_id: string } }
    ) {
      try {
        const token = await getApiAccessToken();
        
        if (!token) {
          return NextResponse.json(
            { error: 'Unauthorized' },
            { status: 401 }
          );
        }
        
        const response = await fetch(
          `${process.env.API_BASE_URL}/api/v1/transitions/warnings/${params.context_id}`,
          {
            headers: {
              'Authorization': `Bearer ${token}`,
              'Content-Type': 'application/json',
            },
          }
        );
        
        if (!response.ok) {
          throw new Error(`Backend error: ${response.status}`);
        }
        
        const data = await response.json();
        return NextResponse.json(data);
        
      } catch (error) {
        console.error('Warnings proxy error:', error);
        return NextResponse.json(
          { error: 'Failed to fetch warnings' },
          { status: 500 }
        );
      }
    }
    ```

- [ ] **Task 4: Create TanStack Query hook for transition suggestions** (AC: 3)
  - [ ] Create `my_flow_client/src/hooks/use-transition-suggestions.ts`
  - [ ] Import required dependencies:
    ```typescript
    import { useQuery } from '@tanstack/react-query';
    import type { TransitionSuggestions } from '@/types/transitions';
    ```
  - [ ] Implement hook:
    ```typescript
    export function useTransitionSuggestions(
      fromContextId: string | null,
      toContextId: string | null,
      enabled: boolean = true
    ) {
      return useQuery({
        queryKey: ['transition-suggestions', fromContextId, toContextId],
        queryFn: async () => {
          if (!fromContextId || !toContextId) {
            throw new Error('Missing context IDs');
          }
          
          // Call Next.js BFF proxy (NOT FastAPI directly)
          const response = await fetch(
            `/api/transitions/suggestions?from=${fromContextId}&to=${toContextId}`
          );
          
          if (!response.ok) {
            throw new Error('Failed to fetch suggestions');
          }
          
          return response.json() as Promise<TransitionSuggestions>;
        },
        enabled: enabled && !!fromContextId && !!toContextId,
        staleTime: 0, // Always fresh (context state changes frequently)
        retry: 1, // Only retry once
      });
    }
    ```
  - [ ] Add error handling
  - [ ] Add JSDoc documentation

- [ ] **Task 5: Create transition suggestions dialog component** (AC: 1, 2, 4)
  - [ ] Create `my_flow_client/src/components/transitions/transition-suggestions.tsx`
  - [ ] Add `'use client'` directive at top
  - [ ] Import required dependencies:
    ```typescript
    import type { ReactElement } from 'react';
    import {
      Dialog,
      DialogContent,
      DialogDescription,
      DialogFooter,
      DialogHeader,
      DialogTitle,
    } from '@/components/ui/dialog';
    import { Button } from '@/components/ui/button';
    import { Badge } from '@/components/ui/badge';
    import { AlertTriangle, Info, ChevronRight } from 'lucide-react';
    import type { Context } from '@/types/api';
    import type { TransitionSuggestions } from '@/types/transitions';
    import { cn } from '@/lib/utils';
    ```
  - [ ] Define component props interface:
    ```typescript
    export interface TransitionSuggestionsDialogProps {
      isOpen: boolean;
      fromContext: Context | null;
      toContext: Context | null;
      suggestions: TransitionSuggestions | null;
      isLoading: boolean;
      onContinue: () => void;
      onCancel: () => void;
    }
    ```
  - [ ] Implement dialog structure (FOLLOW component-styling-guide.md EXACTLY):
    ```typescript
    export function TransitionSuggestionsDialog({
      isOpen,
      fromContext,
      toContext,
      suggestions,
      isLoading,
      onContinue,
      onCancel,
    }: TransitionSuggestionsDialogProps): ReactElement {
      return (
        <Dialog open={isOpen} onOpenChange={(open) => !open && onCancel()}>
          {/* 
            CRITICAL: Follow component-styling-guide.md dialog specifications exactly
            Source: docs/ux-design-tokens/component-styling-guide.md#1037-1128
          */}
          <DialogContent className="
            bg-modal-bg
            border border-modal-border
            rounded-modal
            shadow-modal
            p-6
            max-w-[560px] w-full
            animate-scale-fade-in
          ">
            {/* Header - component-styling-guide.md#1056-1060 */}
            <DialogHeader className="mb-4">
              <DialogTitle className="text-h2 font-semibold text-text-primary">
                Switch to {toContext?.name}?
              </DialogTitle>
              <DialogDescription className="text-base text-text-secondary leading-relaxed">
                You're switching from {fromContext?.name} to {toContext?.name}
              </DialogDescription>
            </DialogHeader>
    
            {/* 
              Loading State - component-styling-guide.md#1568-1686 
              CRITICAL: Use semantic skeleton tokens, NOT arbitrary spacing
            */}
            {isLoading && (
              <div className="space-y-3 py-4">
                <div className="h-skeleton-title bg-bg-tertiary rounded-md w-skeleton-lg animate-pulse" />
                <div className="h-skeleton-text bg-bg-tertiary rounded-md w-skeleton-full animate-pulse" />
                <div className="h-skeleton-text bg-bg-tertiary rounded-md w-skeleton-xl animate-pulse" />
              </div>
            )}
    
            {/* Suggestions Content */}
            {!isLoading && suggestions && (
              <div className="space-y-4">
                {/* 
                  Warnings Section - component-styling-guide.md#1348-1399 
                  CRITICAL: Use alert component tokens exactly
                */}
                {suggestions.warnings.length > 0 && (
                  <div className="
                    flex items-start gap-3
                    bg-alert-warning-bg
                    text-alert-warning-text
                    border border-alert-warning-border
                    px-4 py-3
                    rounded-md
                    text-base leading-relaxed
                  ">
                    <AlertTriangle className="w-5 h-5 mt-0.5 flex-shrink-0" />
                    <div className="flex-1 space-y-1">
                      {suggestions.warnings.map((warning, index) => (
                        <p key={index} className="text-base leading-relaxed">
                          {warning}
                        </p>
                      ))}
                    </div>
                  </div>
                )}
    
                {/* 
                  Suggestions Section (Info Box style)
                  Source: Dev Notes > Strict Component Styling Requirements
                */}
                {suggestions.suggestions.length > 0 && (
                  <div className="
                    flex items-start gap-3
                    bg-bg-tertiary
                    border border-border-default
                    px-4 py-3
                    rounded-md
                  ">
                    <Info className="w-5 h-5 mt-0.5 flex-shrink-0 text-context" />
                    <div className="flex-1 space-y-1">
                      {suggestions.suggestions.map((suggestion, index) => (
                        <p key={index} className="text-base text-text-primary leading-relaxed">
                          {suggestion}
                        </p>
                      ))}
                    </div>
                  </div>
                )}
    
                {/* 
                  Urgent Flows Section 
                  CRITICAL: Use UrgentFlowCard component (see Task 8)
                */}
                {suggestions.urgent_flows.length > 0 && (
                  <div className="space-y-2">
                    <h4 className="text-small font-semibold text-text-primary">
                      Urgent Flows in {toContext?.name}:
                    </h4>
                    <div className="space-y-2 max-h-48 overflow-y-auto">
                      {suggestions.urgent_flows.slice(0, 5).map((flow) => (
                        <UrgentFlowCard key={flow.id} flow={flow} />
                      ))}
                    </div>
                  </div>
                )}
              </div>
            )}
    
            {/* 
              Footer Actions - component-styling-guide.md#1066-1069 
              CRITICAL: Button order: Cancel (secondary) → Continue (primary)
            */}
            <DialogFooter className="flex gap-3 justify-end mt-6">
              {/* Secondary Button - component-styling-guide.md#321-372 */}
              <Button variant="secondary" onClick={onCancel}>
                Cancel
              </Button>
              
              {/* View Flows button (also secondary) */}
              {suggestions && suggestions.urgent_flows.length > 0 && (
                <Button variant="secondary" onClick={() => {
                  // Navigate to toContext flow list
                  window.location.href = `/contexts/${toContext?.id}/flows`;
                }}>
                  View Flows
                  <ChevronRight className="w-4 h-4 ml-2" />
                </Button>
              )}
              
              {/* Primary Button - component-styling-guide.md#256-318 */}
              <Button onClick={onContinue}>
                Continue
              </Button>
            </DialogFooter>
          </DialogContent>
        </Dialog>
      );
    }
    ```
  - [ ] **CRITICAL VERIFICATION:** Compare implementation against component-styling-guide.md:
    - [ ] Dialog uses `bg-modal-bg`, NOT `bg-bg-secondary`
    - [ ] Loading skeleton uses `h-skeleton-*` tokens, NOT `h-4` arbitrary values
    - [ ] Typography uses `text-tiny` (NOT `text-xs`), `text-small` (NOT `text-sm`)
    - [ ] All spacing uses semantic tokens (`p-6`, `gap-3`, `space-y-4`)
    - [ ] Alert uses exact alert component tokens (`bg-alert-warning-bg`, etc.)
    - [ ] Buttons follow exact button specifications from guide

- [ ] **Task 6: Integrate transition suggestions into context switcher** (AC: 3)
  - [ ] Open `my_flow_client/src/components/contexts/context-switcher.tsx`
  - [ ] Import transition suggestions components:
    ```typescript
    import { TransitionSuggestionsDialog } from '@/components/transitions/transition-suggestions';
    import { useTransitionSuggestions } from '@/hooks/use-transition-suggestions';
    ```
  - [ ] Add state for transition flow:
    ```typescript
    const [pendingContextSwitch, setPendingContextSwitch] = useState<{
      from: Context | null;
      to: Context | null;
    } | null>(null);
    ```
  - [ ] Fetch suggestions when context switch is initiated:
    ```typescript
    const { data: suggestions, isLoading } = useTransitionSuggestions(
      pendingContextSwitch?.from?.id ?? null,
      pendingContextSwitch?.to?.id ?? null,
      !!pendingContextSwitch // Only fetch when switch is pending
    );
    ```
  - [ ] Modify context click handler:
    ```typescript
    const handleContextClick = useCallback((context: Context) => {
      if (context.id === currentContext?.id) return; // Already active
      
      // Set pending switch (triggers suggestions fetch)
      setPendingContextSwitch({
        from: currentContext,
        to: context,
      });
    }, [currentContext]);
    ```
  - [ ] Add suggestion dialog rendering:
    ```typescript
    <TransitionSuggestionsDialog
      isOpen={!!pendingContextSwitch}
      fromContext={pendingContextSwitch?.from ?? null}
      toContext={pendingContextSwitch?.to ?? null}
      suggestions={suggestions ?? null}
      isLoading={isLoading}
      onContinue={handleContinueSwitch}
      onCancel={handleCancelSwitch}
    />
    ```
  - [ ] Implement continue handler:
    ```typescript
    const handleContinueSwitch = useCallback(() => {
      if (!pendingContextSwitch?.to) return;
      
      // Actually switch context
      setCurrentContext(pendingContextSwitch.to);
      
      // Clear pending switch
      setPendingContextSwitch(null);
    }, [pendingContextSwitch, setCurrentContext]);
    ```
  - [ ] Implement cancel handler:
    ```typescript
    const handleCancelSwitch = useCallback(() => {
      setPendingContextSwitch(null);
    }, []);
    ```

- [ ] **Task 8: Add conditional rendering logic** (AC: 3)
  - [ ] Modify suggestion dialog to skip if no warnings:
    ```typescript
    // In context switcher
    useEffect(() => {
      if (suggestions && !isLoading) {
        // If no warnings/suggestions/urgent flows, skip dialog
        const hasWarnings = 
          suggestions.warnings.length > 0 ||
          suggestions.suggestions.length > 0 ||
          suggestions.urgent_flows.length > 0;
        
        if (!hasWarnings && pendingContextSwitch) {
          // No issues, proceed immediately
          handleContinueSwitch();
        }
      }
    }, [suggestions, isLoading, pendingContextSwitch, handleContinueSwitch]);
    ```
  - [ ] This ensures smooth UX: dialog only shows when there are actual warnings

- [ ] **Task 7: Create urgent flow mini-card component** (AC: 1, 2)
  - [ ] Create `my_flow_client/src/components/transitions/urgent-flow-card.tsx`
  - [ ] Add `'use client'` directive at top of file
  - [ ] Import dependencies:
    ```typescript
    import type { ReactElement } from 'react';
    import type { Flow } from '@/types/api';
    import { Badge } from '@/components/ui/badge';
    import { cn } from '@/lib/utils';
    ```
  - [ ] Define component (FOLLOW component-styling-guide.md#570-649 EXACTLY):
    ```typescript
    export interface UrgentFlowCardProps {
      flow: Flow;
      className?: string;
    }
    
    export function UrgentFlowCard({ flow, className }: UrgentFlowCardProps): ReactElement {
      const formattedDueDate = flow.due_date
        ? new Date(flow.due_date).toLocaleDateString('en-US', {
            month: 'short',
            day: 'numeric',
          })
        : null;
      
      return (
        <div
          className={cn(
            // Base card styling - component-styling-guide.md#570-585
            "bg-card",                        // ✅ Token utility
            "text-card-text",                 // ✅ Token utility
            "border border-card-border",      // ✅ Token utility
            "border-l-urgent",                // ✅ Token utility (3px semantic width)
            "border-l-error",                 // ✅ Token utility for red urgent indicator
            "p-3",                            // ✅ Semantic spacing (12px)
            "rounded-card",                   // ✅ Token utility (8px radius)
            
            // Animation - component-styling-guide.md#584
            "transition-all duration-fast ease-out",
            
            // Hover state - component-styling-guide.md#593-596
            "hover:bg-card-bg-hover hover:shadow-card-hover",
            "hover:cursor-pointer",
            
            className
          )}
        >
          <div className="flex items-start justify-between gap-2">
            <div className="flex-1 min-w-0">
              {/* 
                Flow title - component-styling-guide.md#630-633 
                CRITICAL: Use text-base, NOT text-sm or text-md
              */}
              <p className="text-base font-medium text-text-primary truncate mb-1">
                {flow.title}
              </p>
              
              {/* 
                Due date - component-styling-guide.md#640-643 
                CRITICAL: Use text-tiny (12px), NOT text-xs
              */}
              {formattedDueDate && (
                <p className="text-tiny text-text-muted">
                  Due: {formattedDueDate}
                </p>
              )}
            </div>
            
            {/* 
              Priority badge - component-styling-guide.md#1024-1033
              CRITICAL: Use text-tiny, destructive variant for urgent/high priority
            */}
            <Badge variant="destructive" className="text-tiny flex-shrink-0">
              {flow.priority}
            </Badge>
          </div>
        </div>
      );
    }
    ```
  - [ ] **CRITICAL VERIFICATION:** Compare implementation against component-styling-guide.md:
    - [ ] Card uses `bg-card`, NOT `bg-bg-secondary` or hardcoded colors
    - [ ] Left border uses semantic token `border-l-urgent` and `border-l-error` (3px red urgent indicator)
    - [ ] Typography uses `text-tiny` (12px) for metadata, NOT `text-xs`
    - [ ] Typography uses `text-base` (16px) for title, NOT `text-sm` or `text-md`
    - [ ] Hover effects match guide: `hover:bg-card-bg-hover hover:shadow-card-hover`
    - [ ] Transition uses `duration-fast` (200ms) and `ease-out`
    - [ ] Badge uses `variant="destructive"` with `text-tiny` class

- [ ] **Task 8: Create unit tests for TransitionSuggestionsDialog** (AC: 5)
  - [ ] Create `my_flow_client/src/components/transitions/__tests__/transition-suggestions.test.tsx`
  - [ ] Import testing utilities:
    ```typescript
    import { render, screen, fireEvent, waitFor } from '@testing-library/react';
    import { describe, it, expect, vi } from 'vitest';
    import { TransitionSuggestionsDialog } from '../transition-suggestions';
    import type { Context } from '@/types/api';
    import type { TransitionSuggestions } from '@/types/transitions';
    ```
  - [ ] Create mock data:
    ```typescript
    const mockFromContext: Context = {
      id: 'ctx-work',
      user_id: 'user123',
      name: 'Work',
      color: '#6366f1',
      icon: '💼',
      created_at: '2025-01-01T00:00:00Z',
      updated_at: '2025-01-01T00:00:00Z',
    };
    
    const mockToContext: Context = {
      id: 'ctx-personal',
      user_id: 'user123',
      name: 'Personal',
      color: '#f59e0b',
      icon: '🏠',
      created_at: '2025-01-01T00:00:00Z',
      updated_at: '2025-01-01T00:00:00Z',
    };
    
    const mockSuggestions: TransitionSuggestions = {
      from_context: 'ctx-work',
      to_context: 'ctx-personal',
      warnings: ['You have 3 incomplete flows in this context'],
      suggestions: ['2 high-priority flows due today'],
      urgent_flows: [
        {
          id: 'flow-1',
          title: 'Review Q4 budget',
          priority: 'high',
          due_date: '2025-01-15T17:00:00Z',
          is_completed: false,
          context_id: 'ctx-personal',
          user_id: 'user123',
          reminder_enabled: true,
          created_at: '2025-01-01T00:00:00Z',
          updated_at: '2025-01-01T00:00:00Z',
        },
      ],
    };
    ```
  - [ ] Test: Dialog renders with context names
  - [ ] Test: Warnings section displays correctly
  - [ ] Test: Suggestions section displays correctly
  - [ ] Test: Urgent flows render with red accent
  - [ ] Test: "Continue" button calls onContinue
  - [ ] Test: "Cancel" button calls onCancel
  - [ ] Test: "View Flows" button navigates correctly
  - [ ] Test: Loading state shows skeleton
  - [ ] Test: Empty state (no warnings) - verify minimal content

- [ ] **Task 9: Create unit tests for UrgentFlowCard** (AC: 5)
  - [ ] Create `my_flow_client/src/components/transitions/__tests__/urgent-flow-card.test.tsx`
  - [ ] Test: Renders flow title
  - [ ] Test: Renders due date in correct format
  - [ ] Test: Renders priority badge
  - [ ] Test: Red left border for urgent indicator
  - [ ] Test: Hover effects apply correctly

- [ ] **Task 10: Create unit tests for useTransitionSuggestions hook** (AC: 5)
  - [ ] Create `my_flow_client/src/hooks/__tests__/use-transition-suggestions.test.tsx`
  - [ ] Import testing utilities:
    ```typescript
    import { renderHook, waitFor } from '@testing-library/react';
    import { describe, it, expect, vi, beforeEach } from 'vitest';
    import { QueryClient, QueryClientProvider } from '@tanstack/react-query';
    import { useTransitionSuggestions } from '../use-transition-suggestions';
    import type { ReactNode } from 'react';
    ```
  - [ ] Create wrapper with QueryClient:
    ```typescript
    const queryClient = new QueryClient({
      defaultOptions: {
        queries: { retry: false },
      },
    });
    
    const wrapper = ({ children }: { children: ReactNode }) => (
      <QueryClientProvider client={queryClient}>
        {children}
      </QueryClientProvider>
    );
    ```
  - [ ] Test: Hook fetches suggestions with correct params
  - [ ] Test: Hook is disabled when contextIds are null
  - [ ] Test: Hook handles API errors gracefully
  - [ ] Test: Hook returns isLoading during fetch
  - [ ] Mock global fetch for testing:
    ```typescript
    beforeEach(() => {
      global.fetch = vi.fn();
    });
    ```

- [ ] **Task 11: Add Storybook stories** (AC: 6)
  - [ ] Create `my_flow_client/src/components/transitions/transition-suggestions.stories.tsx`
  - [ ] Import required dependencies:
    ```typescript
    import type { Meta, StoryObj } from '@storybook/react';
    import { TransitionSuggestionsDialog } from './transition-suggestions';
    import { useState } from 'react';
    ```
  - [ ] Define meta:
    ```typescript
    const meta: Meta<typeof TransitionSuggestionsDialog> = {
      title: 'Transitions/TransitionSuggestionsDialog',
      component: TransitionSuggestionsDialog,
      parameters: {
        layout: 'centered',
        backgrounds: {
          default: 'dark',
          values: [{ name: 'dark', value: '#0a0a0a' }],
        },
      },
    };
    export default meta;
    type Story = StoryObj<typeof TransitionSuggestionsDialog>;
    ```
  - [ ] Story 1: With warnings and urgent flows
  - [ ] Story 2: Empty state (no warnings)
  - [ ] Story 3: Loading state
  - [ ] Story 4: Only warnings (no urgent flows)
  - [ ] Story 5: Only urgent flows (no warnings)

- [ ] **Task 12: Responsive design and mobile optimization** (AC: 1, 2)
  - [ ] Test dialog on mobile viewport (320px - 768px)
  - [ ] Adjust dialog width for mobile:
    - Desktop: `max-w-[560px]`
    - Mobile: `max-w-[95vw]` or full width with padding
  - [ ] Adjust urgent flow list for mobile:
    - Desktop: Show 5 flows max
    - Mobile: Show 3 flows max (smaller viewport)
  - [ ] Ensure buttons stack properly on mobile:
    - Desktop: Horizontal layout (flex-row)
    - Mobile: Vertical stack if needed (flex-col)
  - [ ] Verify touch targets are at least 44px
  - [ ] Test scrolling for long urgent flow lists

- [ ] **Task 13: Add keyboard accessibility** (AC: 1, 3)
  - [ ] Test keyboard navigation:
    - Tab through all interactive elements
    - Enter/Space to activate buttons
    - Escape to cancel (shadcn/ui Dialog handles this)
  - [ ] Verify focus management:
    - Dialog auto-focuses on open
    - Focus trapped within dialog
    - Focus returns to trigger on close
  - [ ] Add aria-labels:
    ```typescript
    <button
      aria-label="Continue to Personal context despite warnings"
      onClick={onContinue}
    >
      Continue
    </button>
    ```

- [ ] **Task 14: Add empty state handling** (AC: 1)
  - [ ] Handle case where suggestions are fetched but empty:
    ```typescript
    // In component
    if (!isLoading && suggestions && 
        suggestions.warnings.length === 0 &&
        suggestions.suggestions.length === 0 &&
        suggestions.urgent_flows.length === 0) {
      // Show minimal dialog or skip entirely
      return (
        <Dialog open={isOpen} onOpenChange={(open) => !open && onCancel()}>
          <DialogContent>
            <DialogHeader>
              <DialogTitle>Switch to {toContext?.name}</DialogTitle>
              <DialogDescription>
                No pending tasks. You're all set!
              </DialogDescription>
            </DialogHeader>
            <DialogFooter>
              <Button onClick={onContinue}>Continue</Button>
            </DialogFooter>
          </DialogContent>
        </Dialog>
      );
    }
    ```
  - [ ] Or auto-proceed if no warnings (handled in Task 7)

- [ ] **Task 15: Code quality and compliance** (AC: All)
  - [ ] Run linter: `cd my_flow_client && bun run lint`
  - [ ] Fix any linting errors
  - [ ] Run type checker: `bun run typecheck`
  - [ ] Fix any type errors
  - [ ] Verify import order follows coding standards
  - [ ] Verify component naming conventions
  - [ ] **CRITICAL: Verify component-styling-guide.md compliance:**
    - [ ] Search all component files for `text-xs` → Should be `text-tiny`
    - [ ] Search for `text-sm` → Should be `text-small`
    - [ ] Search for `text-lg` → Should be `text-large`
    - [ ] Search for `h-4`, `h-8` in loading states → Should be `h-skeleton-*`
    - [ ] Search for `bg-[#` or `text-[#` → Should use semantic tokens
    - [ ] Verify Dialog uses `bg-modal-bg` NOT `bg-bg-secondary`
    - [ ] Verify Alert uses `bg-alert-warning-bg` NOT arbitrary values
    - [ ] Verify Urgent flow cards use `border-l-urgent border-l-error` NOT `border-l-[3px]`
    - [ ] Verify CSS tokens are properly defined in `my_flow_client/src/app/styles/tokens/effects.css`
    - [ ] Verify token mappings exist in `my_flow_client/src/app/globals.css` @theme section
  - [ ] Run all tests: `bun test`
  - [ ] Verify 80%+ coverage: `bun test --coverage`

- [ ] **Task 16: Integration testing with existing context switcher** (AC: 3)
  - [ ] Manually test complete transition flow:
    - Open context switcher
    - Click different context
    - Verify dialog appears with suggestions
    - Click "Cancel" - verify context doesn't change
    - Click "Continue" - verify context switches
  - [ ] Test with various scenarios:
    - Source context with incomplete flows
    - Target context with urgent flows
    - Both contexts with issues
    - No warnings (smooth switch)
  - [ ] Verify API integration:
    - Check Network tab shows calls to `/api/transitions/suggestions`
    - Verify JWT token not exposed in browser
    - Verify backend responds correctly

## Dev Notes

### Backend API Integration (Stories 4.2 & 4.3)

**Available Backend Endpoints:**

**1. Transition Suggestions API (Story 4.2):**
- Endpoint: `GET /api/v1/transitions/suggestions?from={context_id}&to={context_id}`
- Purpose: Provides warnings about source context and suggestions for target context
- Response:
  ```json
  {
    "from_context": "ctx-work-123",
    "to_context": "ctx-personal-456",
    "warnings": ["You have 3 incomplete flows in this context"],
    "suggestions": ["2 flows overdue in this context", "1 high-priority flow due today"],
    "urgent_flows": [
      {
        "id": "flow-1",
        "title": "Review Q4 budget",
        "priority": "high",
        "due_date": "2025-01-12T17:00:00Z",
        "is_completed": false
      }
    ]
  }
  ```

**2. Incomplete Flow Warnings API (Story 4.3):**
- Endpoint: `GET /api/v1/transitions/warnings/{context_id}`
- Purpose: Checks single context for incomplete/overdue flows
- Response:
  ```json
  {
    "context_id": "ctx-work-123",
    "incomplete_count": 5,
    "overdue_count": 2,
    "overdue_flows": [...]
  }
  ```

**Frontend Uses Story 4.2 (Transition Suggestions) Primarily:**
- Provides comprehensive view: source warnings + target suggestions
- Single API call covers both contexts
- Urgent flows included for display

[Source: docs/stories/4.2.story.md, docs/stories/4.3.story.md]

---

### BFF Proxy Pattern (Critical Architecture Rule)

**CRITICAL: Browser NEVER calls FastAPI directly.**

**Architecture Flow:**
```
Browser → Next.js API Route → FastAPI Backend
   (session cookie)  →  (JWT added server-side)  →  (validates JWT)
```

**Frontend API Calls:**

```typescript
// ❌ WRONG: Direct call to FastAPI
const response = await fetch('https://api.myflow.app/api/v1/transitions/suggestions', {
  headers: { Authorization: `Bearer ${token}` } // Token exposed!
});

// ✅ CORRECT: Call Next.js BFF proxy
const response = await fetch(
  `/api/transitions/suggestions?from=${fromId}&to=${toId}`
); // Next.js route, no auth header needed
const suggestions = await response.json();
```

**Next.js API Route Pattern:**

```typescript
// app/api/transitions/suggestions/route.ts
import { getApiAccessToken } from '@logto/next/server-actions';

export async function GET(request: Request) {
  // 1. Get JWT server-side (never exposed to browser)
  const token = await getApiAccessToken();
  
  // 2. Call FastAPI with token
  const response = await fetch(`${API_BASE_URL}/api/v1/transitions/suggestions?...`, {
    headers: { Authorization: `Bearer ${token}` },
  });
  
  // 3. Proxy response back (without token)
  return Response.json(await response.json());
}
```

**Security Benefits:**
- JWT tokens NEVER exposed to browser
- Session cookies are HttpOnly, Secure, SameSite=Lax
- Token refresh handled server-side by Logto SDK
- No CORS configuration needed

[Source: docs/architecture/coding-standards.md#2, docs/architecture/frontend-architecture.md]

---

### Strict Component Styling Requirements

**CRITICAL: This story MUST follow `docs/ux-design-tokens/component-styling-guide.md` EXACTLY.**

All components MUST use CSS design tokens via Tailwind utility classes. NEVER use hardcoded hex values or arbitrary `[var(--token)]` syntax unless EXPLICITLY specified in the component styling guide for special cases.

---

#### Dialog/Modal Component Specifications

**From component-styling-guide.md (lines 1037-1128):**

```typescript
// Backdrop
<DialogOverlay className="
  fixed inset-0
  bg-[var(--modal-backdrop)]      // ⚠️ EXCEPTION: Use arbitrary value here
  z-modal-backdrop
  animate-fade-in
" />

// Modal Container
<DialogContent className="
  fixed left-1/2 top-1/2
  -translate-x-1/2 -translate-y-1/2
  bg-modal-bg                     // ✅ Token utility
  border border-modal-border      // ✅ Token utility
  rounded-modal                   // ✅ Token utility
  shadow-modal                    // ✅ Token utility
  p-6
  max-w-[560px] w-full           // ⚠️ EXCEPTION: Specific max-width
  z-modal
  animate-scale-fade-in
">
  // Header
  <DialogHeader className="mb-4">
    <DialogTitle className="text-h2 font-semibold text-text-primary">
      // Title text
    </DialogTitle>
    <DialogDescription className="text-base text-text-secondary leading-relaxed">
      // Description text
    </DialogDescription>
  </DialogHeader>

  // Body: text-base leading-loose text-text-primary mb-6

  // Footer
  <DialogFooter className="flex gap-3 justify-end">
    <Button variant="secondary">Cancel</Button>
    <Button>Continue</Button>
  </DialogFooter>
</DialogContent>
```

**Animation Requirements:**
- Entry: Fade + scale up from 0.95
- Duration: 300ms (`--anim-duration-normal`)
- Easing: ease-out (`--anim-ease-out`)

[Source: docs/ux-design-tokens/component-styling-guide.md#1037-1128]

---

#### Button Component Specifications

**Primary Button (Continue):**

```typescript
<Button className="
  bg-bg-tertiary
  text-text-primary
  border border-border-default
  px-5 py-3
  rounded-button
  text-base font-medium leading-normal
  transition-all duration-fast ease-out
  hover:bg-bg-elevated hover:border-context
  hover:shadow-[0_0_0_1px_var(--color-context-current)]  // ⚠️ EXCEPTION: Glow effect
  active:scale-[0.98]
  focus-visible:outline-none focus-visible:shadow-focus
  disabled:bg-bg-secondary disabled:text-text-disabled
  disabled:border-border-subtle disabled:opacity-50
  disabled:cursor-not-allowed
">
  Continue
</Button>
```

**Secondary Button (Cancel):**

```typescript
<Button variant="secondary" className="
  bg-transparent
  text-text-primary
  border border-border-default
  px-5 py-3
  rounded-button
  text-base font-medium
  transition-all duration-fast ease-out
  hover:bg-slate-700/10 hover:border-context  // ⚠️ EXCEPTION: Semi-transparent bg
  active:bg-slate-700/20 active:scale-[0.98]  // ⚠️ EXCEPTION: Semi-transparent bg
  focus-visible:outline-none focus-visible:shadow-focus
  disabled:text-text-disabled disabled:border-border-subtle
  disabled:opacity-50 disabled:cursor-not-allowed
">
  Cancel
</Button>
```

**Danger Badge (Priority Indicator):**

```typescript
<Badge variant="destructive" className="
  text-tiny          // ⚠️ CRITICAL: Use text-tiny (12px), NOT text-xs
  flex-shrink-0
">
  {flow.priority}
</Badge>
```

[Source: docs/ux-design-tokens/component-styling-guide.md#256-476]

---

#### Alert Component Specifications

**Warning Alert (For Transition Warnings):**

```typescript
<div className="
  flex items-start gap-3
  bg-alert-warning-bg
  text-alert-warning-text
  border border-alert-warning-border
  px-4 py-3
  rounded-md
  text-base leading-relaxed
">
  <AlertTriangle className="w-5 h-5 mt-0.5 flex-shrink-0" />
  <div>
    <p className="text-base leading-relaxed">
      {warning}
    </p>
  </div>
</div>
```

**Info Box (For Suggestions):**

```typescript
<div className="
  flex items-start gap-3
  bg-bg-tertiary
  border border-border-default
  px-4 py-3
  rounded-md
">
  <Info className="w-5 h-5 mt-0.5 flex-shrink-0 text-context" />
  <div className="flex-1 space-y-1">
    <p className="text-base text-text-primary leading-relaxed">
      {suggestion}
    </p>
  </div>
</div>
```

[Source: docs/ux-design-tokens/component-styling-guide.md#1348-1417]

---

#### Urgent Flow Card Specifications

**Card with Red Left Border (Urgent Indicator):**

```typescript
<div className="
  bg-card                        // ✅ Token utility
  text-card-text                 // ✅ Token utility
  border border-card-border      // ✅ Token utility
  border-l-urgent                // ✅ Token utility (3px semantic width)
  border-l-error                 // ✅ Token utility for red
  p-3
  rounded-card                   // ✅ Token utility
  transition-all duration-fast ease-out
  hover:bg-card-bg-hover hover:shadow-card-hover
  hover:cursor-pointer
">
  <div className="flex items-start justify-between gap-2">
    <div className="flex-1 min-w-0">
      // Title
      <p className="text-base font-medium text-text-primary truncate mb-1">
        {flow.title}
      </p>
      
      // Due date
      <p className="text-tiny text-text-muted">  // ⚠️ CRITICAL: Use text-tiny, NOT text-xs
        Due: {formattedDueDate}
      </p>
    </div>
    
    // Priority badge
    <Badge variant="destructive" className="text-tiny flex-shrink-0">
      {flow.priority}
    </Badge>
  </div>
</div>
```

[Source: docs/ux-design-tokens/component-styling-guide.md#570-649]

---

#### Loading Skeleton Specifications

**CRITICAL: Use semantic skeleton tokens, NOT arbitrary spacing utilities.**

```typescript
// ❌ WRONG: Arbitrary spacing utilities
<div className="h-4 bg-bg-tertiary rounded-md animate-pulse" />
<div className="h-8 w-8 rounded-full bg-bg-secondary animate-pulse" />

// ✅ CORRECT: Semantic skeleton tokens
<div className="h-skeleton-text bg-bg-tertiary rounded-md w-skeleton-lg animate-pulse" />
<div className="h-skeleton-avatar w-skeleton-avatar rounded-full bg-bg-secondary animate-pulse" />
<div className="h-skeleton-input bg-bg-secondary rounded-md animate-pulse" />
```

**Available Skeleton Utilities:**

| Utility | Token | Value | Use Case |
|---------|-------|-------|----------|
| `h-skeleton-text` | `--token-skeleton-text` | 16px | Body text lines |
| `h-skeleton-title` | `--token-skeleton-title` | 24px | Heading/title lines |
| `h-skeleton-avatar` | `--token-skeleton-avatar` | 32px | Avatar circles |
| `h-skeleton-input` | `--token-skeleton-input` | 44px | Form input fields |
| `h-skeleton-button` | `--token-skeleton-button` | 40px | Button elements |
| `w-skeleton-full` | `--width-skeleton-full` | 100% | Full-width lines |
| `w-skeleton-lg` | `--width-skeleton-lg` | 75% | Large lines (most common) |
| `w-skeleton-md` | `--width-skeleton-md` | 60% | Medium lines |

**Example Loading State:**

```typescript
{isLoading && (
  <div className="space-y-3 py-4">
    <div className="h-skeleton-title bg-bg-tertiary rounded-md w-skeleton-lg animate-pulse" />
    <div className="h-skeleton-text bg-bg-tertiary rounded-md w-skeleton-full animate-pulse" />
    <div className="h-skeleton-text bg-bg-tertiary rounded-md w-skeleton-xl animate-pulse" />
  </div>
)}
```

[Source: docs/ux-design-tokens/component-styling-guide.md#1568-1686]

---

#### Typography Scale (CRITICAL)

**Use EXACT font size tokens from the guide:**

```typescript
// Headings
text-h1:    32px, font-bold (700), leading-tight (1.2)
text-h2:    24px, font-semibold (600), leading-snug (1.3)
text-h3:    20px, font-semibold (600), leading-normal (1.4)

// Body Text
text-large: 18px, font-regular (400), leading-relaxed (1.5)
text-base:  16px, font-regular (400), leading-loose (1.6)
text-small: 14px, font-regular (400), leading-relaxed (1.5)
text-tiny:  12px, font-medium (500), leading-normal (1.4)  // ⚠️ CRITICAL: Use text-tiny NOT text-xs
```

**DO NOT use Tailwind's default text utilities:**
- ❌ `text-xs` (use `text-tiny` instead)
- ❌ `text-sm` (use `text-small` instead)
- ❌ `text-lg` (use `text-large` instead)

[Source: docs/ux-design-tokens/component-styling-guide.md#1950-1991]

---

#### Spacing & Layout Tokens

**Component Spacing:**

```typescript
// Cards
p-4:        Internal padding (16px)
gap-3:      Gap between items (12px)

// Forms
mb-2:       Label to input (8px)
mb-4:       Between fields (16px)
mb-6:       Field to button (24px)

// Sections
space-y-4:  Between sections (16px)
```

[Source: docs/ux-design-tokens/component-styling-guide.md#1917-1949]

---

#### Exceptions Summary (When Arbitrary Values ARE Allowed)

The component styling guide specifies EXACT cases where arbitrary values are permitted:

1. **Modal backdrop:** `bg-[var(--modal-backdrop)]` - Specific transparency requirement
2. **Button glow effect:** `hover:shadow-[0_0_0_1px_var(--color-context-current)]` - Specific glow ring
3. **Secondary button hover:** `hover:bg-slate-700/10` - Semi-transparent overlay
4. **Max widths for containers:** `max-w-[560px]`, `max-w-[95vw]` - Specific responsive breakpoints
5. **Context color backgrounds:** `bg-[var(--color-context-current)]` - Dynamic context colors

**NOTE:** Border widths now have proper semantic tokens:
- Use `border-l-flow` for flow cards (3px context-colored border)
- Use `border-l-urgent` for urgent indicators (3px red border)

**ALL OTHER STYLING MUST USE SEMANTIC TOKENS.**

[Source: docs/ux-design-tokens/component-styling-guide.md#258-289]

---

#### Developer Checklist for This Story

When implementing components, ensure:

- [ ] All colors use design tokens (no hardcoded hex values except exceptions above)
- [ ] All spacing uses token scale (`--space-*` via Tailwind utilities)
- [ ] All typography uses token definitions (`text-tiny`, `text-small`, `text-base`, etc.)
- [ ] Hover states are defined and smooth (200ms transition via `duration-fast`)
- [ ] Focus states are WCAG AA compliant (2px ring via `shadow-focus`)
- [ ] Active states provide tactile feedback (`scale-[0.98]`)
- [ ] Disabled states are clearly distinguishable (opacity 0.5 via `opacity-50`)
- [ ] Loading states use skeleton tokens (`h-skeleton-*`, `w-skeleton-*`)
- [ ] Animations use defined durations (`duration-fast`, `duration-normal`)
- [ ] Component is keyboard accessible (`focus-visible` styles)
- [ ] Context color integration is appropriate (subtle accents only)

[Source: docs/ux-design-tokens/component-styling-guide.md#1994-2010]

---

### Dialog Component Specifications

**From Component Styling Guide:**

**Modal/Dialog Structure:**
```
Backdrop: bg-[var(--modal-backdrop)] (rgba(10, 10, 10, 0.6))
Container: bg-bg-secondary, border border-border-default
Border Radius: rounded-modal (12px)
Shadow: shadow-modal (large elevation)
Padding: p-6 (24px)
Max Width: max-w-[560px]
```

**Header:**
- Title: `text-h2 font-semibold` (24px, weight 600)
- Description: `text-base text-text-secondary leading-relaxed`
- Margin bottom: `mb-4`

**Body:**
- Font size: `text-base`
- Line height: `leading-loose` (1.6)
- Margin bottom: `mb-6`

**Footer:**
- Display: `flex gap-3 justify-end`
- Button order: Cancel (secondary) → Continue (primary)

**Animation:**
- Entry: Fade + scale up from 0.95
- Duration: 300ms
- Easing: ease-out

[Source: docs/ux-design-tokens/component-styling-guide.md#1036-1129]

---

### shadcn/ui Dialog Component

**Installed Components:**

From `my_flow_client/src/components/ui/`, the following shadcn/ui components are available:
- ✅ `button.tsx` - Button component
- ✅ `badge.tsx` - Badge component
- ✅ `card.tsx` - Card component
- ✅ `dropdown-menu.tsx` - Dropdown menu

**Dialog Component May Need Installation:**

If `dialog.tsx` doesn't exist in `components/ui/`, install it:
```bash
cd my_flow_client
bunx shadcn@latest add dialog
```

**Dialog Usage Pattern:**

```typescript
import {
  Dialog,
  DialogContent,
  DialogDescription,
  DialogFooter,
  DialogHeader,
  DialogTitle,
} from '@/components/ui/dialog';

<Dialog open={isOpen} onOpenChange={onOpenChange}>
  <DialogContent>
    <DialogHeader>
      <DialogTitle>Title</DialogTitle>
      <DialogDescription>Description</DialogDescription>
    </DialogHeader>
    {/* Content */}
    <DialogFooter>
      <Button>Action</Button>
    </DialogFooter>
  </DialogContent>
</Dialog>
```

[Source: Project component structure inspection]

---

### Context Switcher Integration

**Existing Context Switcher:**

From `my_flow_client/src/components/contexts/context-switcher.tsx`:
- Already exists and handles context selection
- Uses TanStack Query for context data
- Manages current context state
- Displays context grid with cards

**Integration Strategy:**

1. **Add transition flow state** to context switcher
2. **Intercept context clicks** to trigger transition check
3. **Fetch suggestions** from backend via hook
4. **Show dialog** if warnings/suggestions exist
5. **Auto-proceed** if no warnings (smooth UX)
6. **Execute switch** when user confirms

**State Management:**

```typescript
// Add to context-switcher.tsx
const [pendingSwitch, setPendingSwitch] = useState<{
  from: Context;
  to: Context;
} | null>(null);

// Fetch suggestions when switch is pending
const { data: suggestions, isLoading } = useTransitionSuggestions(
  pendingSwitch?.from.id ?? null,
  pendingSwitch?.to.id ?? null,
  !!pendingSwitch
);

// Auto-proceed if no warnings
useEffect(() => {
  if (suggestions && !isLoading && pendingSwitch) {
    const hasIssues = /* check warnings/suggestions/urgent_flows */;
    if (!hasIssues) {
      executeSwitch(pendingSwitch.to);
    }
  }
}, [suggestions, isLoading, pendingSwitch]);
```

[Source: docs/stories/3.7.story.md - Similar pattern for flow extraction notifications]

---

### Testing Strategy

**Unit Tests (Vitest + React Testing Library):**

**Test Coverage Requirements (80% minimum):**
- Component rendering with different suggestion states
- Button click callbacks (Continue, Cancel, View Flows)
- Loading states
- Empty states (no warnings)
- Accessibility attributes
- Responsive layout

**Test Files:**
- `transition-suggestions.test.tsx` - Dialog component tests
- `urgent-flow-card.test.tsx` - Mini card component tests
- `use-transition-suggestions.test.tsx` - Hook tests

**Test Pattern:**
```typescript
describe('TransitionSuggestionsDialog', () => {
  it('renders warnings and suggestions', () => {
    render(
      <TransitionSuggestionsDialog
        isOpen={true}
        fromContext={mockFromContext}
        toContext={mockToContext}
        suggestions={mockSuggestions}
        isLoading={false}
        onContinue={vi.fn()}
        onCancel={vi.fn()}
      />
    );
    
    expect(screen.getByText(/Switch to Personal/i)).toBeInTheDocument();
    expect(screen.getByText(/You have 3 incomplete flows/i)).toBeInTheDocument();
  });
  
  it('calls onContinue when Continue button clicked', async () => {
    const mockOnContinue = vi.fn();
    
    render(/* ... onContinue={mockOnContinue} */);
    
    const continueButton = screen.getByRole('button', { name: /continue/i });
    fireEvent.click(continueButton);
    
    expect(mockOnContinue).toHaveBeenCalledOnce();
  });
});
```

**Integration Tests:**
- Not required for this story (dialog is UI-only)
- E2E tests will cover full context switching flow in later stories

[Source: docs/architecture/13-testing-strategy.md]

---

### File Structure & Dependencies

**New Files to Create:**
- `my_flow_client/src/components/transitions/transition-suggestions.tsx` - Main dialog component
- `my_flow_client/src/components/transitions/urgent-flow-card.tsx` - Mini card for urgent flows
- `my_flow_client/src/hooks/use-transition-suggestions.ts` - TanStack Query hook
- `my_flow_client/src/types/transitions.ts` - TypeScript interfaces
- `my_flow_client/src/app/api/transitions/suggestions/route.ts` - Next.js BFF proxy
- `my_flow_client/src/app/api/transitions/warnings/[context_id]/route.ts` - Next.js BFF proxy
- `my_flow_client/src/components/transitions/__tests__/transition-suggestions.test.tsx` - Component tests
- `my_flow_client/src/components/transitions/__tests__/urgent-flow-card.test.tsx` - Card tests
- `my_flow_client/src/hooks/__tests__/use-transition-suggestions.test.tsx` - Hook tests
- `my_flow_client/src/components/transitions/transition-suggestions.stories.tsx` - Storybook

**Files to Modify:**
- `my_flow_client/src/components/contexts/context-switcher.tsx` - Add transition logic

**Files to Reference (DO NOT MODIFY):**
- `my_flow_client/src/types/api.ts` - Context and Flow types
- `my_flow_client/src/components/ui/dialog.tsx` - shadcn/ui Dialog (install if missing)
- `my_flow_client/src/components/ui/button.tsx` - shadcn/ui Button
- `my_flow_client/src/components/ui/badge.tsx` - shadcn/ui Badge

[Source: docs/architecture/9-unified-project-structure.md]

---

### Frontend Architecture Patterns

**Client Component Pattern:**

All transition components are Client Components (require `'use client'`):
- Need state management (`useState` for pending switch)
- Need event handlers (`onClick` for Continue/Cancel)
- Need browser APIs (fetch for API calls via hooks)
- shadcn/ui Dialog requires client-side rendering

**TanStack Query Pattern:**

```typescript
// Custom hook pattern
export function useTransitionSuggestions(from, to, enabled) {
  return useQuery({
    queryKey: ['transition-suggestions', from, to],
    queryFn: async () => {
      const response = await fetch(`/api/transitions/suggestions?from=${from}&to=${to}`);
      return response.json();
    },
    enabled, // Only fetch when needed
    staleTime: 0, // Always fresh
    retry: 1,
  });
}

// Usage in component
const { data, isLoading, error } = useTransitionSuggestions(
  fromContext?.id ?? null,
  toContext?.id ?? null,
  !!pendingSwitch
);
```

[Source: docs/architecture/frontend-architecture.md#236-300]

---

### Urgent Flow Display Logic

**Display Rules:**

1. **Maximum Flows:** Show up to 5 urgent flows (prevent overwhelming dialog)
2. **Sorting:** Flows already sorted by backend (overdue first, then soonest)
3. **Truncation:** Flow titles truncated to fit card width
4. **Priority Badge:** Shows priority with appropriate color:
   - High: `variant="destructive"` (error color)
   - Medium: Context color
   - Low: Muted gray

**Flow Card Structure:**

```typescript
<UrgentFlowCard flow={flow}>
  ├── Left border (3px, error color - urgent indicator)
  ├── Title (truncated, medium weight)
  ├── Due date (tiny font, muted color)
  └── Priority badge (destructive variant)
</UrgentFlowCard>
```

**Scrollable List:**

If more than 5 flows, container should scroll:
- Max height: `max-h-48` (192px)
- Overflow: `overflow-y-auto`
- Shadow at top/bottom to indicate scrollable content

[Source: Epic 4.4 AC, docs/ux-design-tokens/component-styling-guide.md]

---

### Dialog Flow & User Experience

**Interaction Flow:**

1. **User clicks context** in context switcher
2. **Frontend sets pending switch state** (from current, to clicked)
3. **Hook fetches suggestions** from `/api/transitions/suggestions`
4. **Dialog opens** IF warnings/suggestions/urgent_flows exist
5. **User reviews** warnings and urgent flows
6. **User decides:**
   - Click "Cancel" → Reset pending switch, stay in current context
   - Click "View Flows" → Navigate to target context flow list
   - Click "Continue" → Execute context switch despite warnings

**Auto-Skip Dialog:**

If no warnings/suggestions/urgent flows:
- Dialog doesn't show
- Context switches immediately
- Smooth, uninterrupted UX

**Loading State:**

While fetching suggestions:
- Dialog shows loading skeleton
- Prevents premature actions
- Duration: typically <200ms (fast API)

[Source: Epic 4.4 AC#3]

---

### Accessibility Requirements

**ARIA Attributes:**

```typescript
<Dialog
  role="dialog"
  aria-labelledby="transition-dialog-title"
  aria-describedby="transition-dialog-description"
>
  <DialogTitle id="transition-dialog-title">
    Switch to Personal?
  </DialogTitle>
  <DialogDescription id="transition-dialog-description">
    You're switching from Work to Personal
  </DialogDescription>
</Dialog>
```

**Keyboard Navigation:**
- Tab: Navigate through elements
- Enter/Space: Activate buttons
- Escape: Close dialog (cancel)
- Focus trap: Keep focus within dialog

**Screen Reader Support:**
- Dialog announces on open: "Switch to Personal? Dialog"
- Warnings announced as alerts
- Urgent flow count announced: "3 urgent flows"
- Button states announced: "Continue button", "Cancel button"

[Source: docs/architecture/frontend-architecture.md#835-874]

---

### TypeScript Type Safety

**Type Imports:**

```typescript
import type { Context, Flow } from '@/types/api';
import type { TransitionSuggestions, IncompleteFlowWarning } from '@/types/transitions';
```

**Component Props:**

All component props MUST have explicit interface definitions:

```typescript
export interface TransitionSuggestionsDialogProps {
  isOpen: boolean;
  fromContext: Context | null;
  toContext: Context | null;
  suggestions: TransitionSuggestions | null;
  isLoading: boolean;
  onContinue: () => void;
  onCancel: () => void;
}

export interface UrgentFlowCardProps {
  flow: Flow;
  className?: string;
}
```

**Return Types:**

All functional components MUST have explicit return types:

```typescript
export function TransitionSuggestionsDialog(
  props: TransitionSuggestionsDialogProps
): ReactElement {
  // Component implementation
}
```

[Source: docs/architecture/coding-standards.md, React 19 conventions]

---

### Performance Considerations

**Optimization Strategies:**

1. **Lazy Hook Activation:**
   - Only fetch suggestions when switch is pending
   - `enabled: !!pendingSwitch` prevents unnecessary requests

2. **Memoization:**
   - Wrap `UrgentFlowCard` with `React.memo` to prevent re-renders
   - Use `useCallback` for event handlers

3. **Limited Flow Display:**
   - Show maximum 5 urgent flows (prevent dialog overflow)
   - Use `.slice(0, 5)` to limit array

4. **Fast Dialog Animations:**
   - Entry: 300ms (feels instant)
   - Keep animations smooth, not sluggish

**Implementation:**

```typescript
export const UrgentFlowCard = React.memo(({ flow, className }: UrgentFlowCardProps) => {
  // Component implementation
});

const handleContinue = useCallback(() => {
  onContinue();
}, [onContinue]);

const handleCancel = useCallback(() => {
  onCancel();
}, [onCancel]);
```

[Source: docs/architecture/frontend-architecture.md#879-895]

---

### Error Handling

**API Error Scenarios:**

1. **Network Error:** Backend unreachable
   - Show error state in dialog: "Unable to check transition"
   - Provide "Continue Anyway" option
   - Log error to console

2. **401 Unauthorized:** JWT token expired
   - Redirect to login
   - Logto SDK handles this automatically

3. **500 Server Error:** Backend issue
   - Show error state
   - Allow user to proceed or cancel

**Implementation:**

```typescript
const { data, isLoading, error } = useTransitionSuggestions(from, to, enabled);

if (error) {
  return (
    <Dialog>
      <DialogContent>
        <DialogHeader>
          <DialogTitle>Unable to Check Transition</DialogTitle>
          <DialogDescription>
            We couldn't check for warnings. Do you want to proceed anyway?
          </DialogDescription>
        </DialogHeader>
        <DialogFooter>
          <Button variant="secondary" onClick={onCancel}>
            Cancel
          </Button>
          <Button onClick={onContinue}>
            Continue Anyway
          </Button>
        </DialogFooter>
      </DialogContent>
    </Dialog>
  );
}
```

[Source: docs/architecture/frontend-architecture.md#794-818]

---

### Responsive Design Requirements

**Mobile Viewport (320px - 768px):**

**Dialog Adjustments:**
- Max width: `max-w-[95vw]` on mobile (instead of fixed 560px)
- Padding: `p-4` on mobile (instead of p-6 on desktop)
- Font sizes: Same (16px is mobile-friendly)

**Button Layout:**
- Desktop: Horizontal (`flex-row justify-end`)
- Mobile: Can stack vertically if needed (`flex-col`)

**Urgent Flow List:**
- Desktop: Show 5 flows max
- Mobile: Show 3 flows max (smaller viewport)
- Scrollable: `overflow-y-auto` with `max-h-48`

**Touch Targets:**
- All buttons: Minimum 44px height
- All interactive elements: Minimum 44x44px tap area

**Responsive Classes:**

```typescript
<DialogContent className="
  max-w-[560px] md:max-w-[560px] sm:max-w-[95vw]
  p-4 md:p-6
">
  <DialogFooter className="
    flex gap-3
    flex-col sm:flex-row
    justify-end
  ">
    {/* Buttons */}
  </DialogFooter>
</DialogContent>
```

[Source: docs/architecture/frontend-architecture.md, Tailwind responsive design]

---

### Previous Story Integration

**From Story 3.7 (Flow Extraction Feedback UI):**
- Pattern for notification/dialog components
- Client Component architecture with state management
- TanStack Query integration patterns
- CSS design token usage in components
- Accessibility implementation (ARIA, keyboard navigation)

**From Story 2.x (Context Management):**
- Context model structure (`Context` type)
- Context switcher UI component exists
- Current context state management

**Integration Points:**

This story extends the Context Switcher by:
1. Adding transition suggestion check before switch
2. Showing dialog with warnings/suggestions if issues exist
3. Allowing user to make informed decision
4. Auto-proceeding if no warnings (smooth UX)

[Source: docs/stories/3.7.story.md, my_flow_client/src/components/contexts/]

---

## Testing

### Test File Organization

**Unit Tests:**
```
my_flow_client/src/
├── components/transitions/__tests__/
│   ├── transition-suggestions.test.tsx  (NEW - dialog component)
│   └── urgent-flow-card.test.tsx        (NEW - mini card)
└── hooks/__tests__/
    └── use-transition-suggestions.test.tsx  (NEW - hook)
```

**Storybook:**
```
my_flow_client/src/components/transitions/
└── transition-suggestions.stories.tsx  (NEW - if Storybook configured)
```

[Source: docs/architecture/13-testing-strategy.md]

---

### Running Tests

```bash
# Run all transition component tests
cd my_flow_client
bun test src/components/transitions/__tests__/

# Run with coverage
bun test src/components/transitions/__tests__/ --coverage

# Run hook tests
bun test src/hooks/__tests__/use-transition-suggestions.test.tsx

# Run all tests
bun test

# Watch mode
bun test --watch
```

[Source: docs/architecture/13-testing-strategy.md]

---

### Manual Testing Workflow

**Setup:**
1. Start backend: `cd my_flow_api && python -m src.main`
2. Start frontend: `cd my_flow_client && op run -- bun dev`
3. Login with test user
4. Create 2+ contexts (e.g., Work, Personal)
5. Add incomplete flows to one context

**Test Scenario 1: Context with Incomplete Flows**
1. Navigate to "Work" context
2. Add 3 incomplete flows (1 high priority)
3. Click "Personal" context in switcher
4. ✓ Dialog opens with warnings
5. ✓ Warnings show "3 incomplete flows in this context"
6. ✓ "Continue" and "Cancel" buttons visible
7. Click "Cancel"
8. ✓ Context remains "Work"

**Test Scenario 2: Target Context with Urgent Flows**
1. Add 2 flows to "Personal" context:
   - Flow 1: High priority, due today
   - Flow 2: Medium priority, overdue
2. From "Work", click "Personal" context
3. ✓ Dialog shows suggestions about target context
4. ✓ Urgent flows section displays both flows
5. ✓ Flows have red left border (urgent indicator)
6. ✓ "View Flows" button visible
7. Click "View Flows"
8. ✓ Navigates to Personal context flow list

**Test Scenario 3: No Warnings (Smooth Switch)**
1. Complete all flows in both contexts
2. Click different context
3. ✓ Dialog does NOT appear
4. ✓ Context switches immediately
5. ✓ Smooth, uninterrupted UX

**Test Scenario 4: Loading State**
1. Slow down network (Chrome DevTools throttling)
2. Click different context
3. ✓ Dialog opens with loading skeleton
4. ✓ Buttons disabled during load
5. ✓ Suggestions appear after fetch completes

**Test Scenario 5: API Error**
1. Stop backend server
2. Click different context
3. ✓ Error state shows in dialog
4. ✓ "Continue Anyway" option available
5. ✓ User can cancel or proceed

**Test Scenario 6: Mobile Responsiveness**
1. Resize browser to 375px width
2. Trigger transition dialog
3. ✓ Dialog fits viewport
4. ✓ Buttons stack correctly
5. ✓ Touch targets are at least 44px
6. ✓ Scrolling works for urgent flow list

[Source: Epic 4.4 AC, manual testing best practices]

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-12 | 1.0 | Story created for Epic 4.4 - Transition Suggestions UI | Bob (Scrum Master) |
| 2025-01-12 | 1.1 | Story cancelled - Modal UX breaks conversation flow. Recommend conversational AI approach instead | James (Dev Agent) + Product Team |

## Dev Agent Record

### Agent Model Used
Claude Sonnet 4.5 (Cursor)

### Debug Log References
- Linting: `bun run lint` - All checks passed
- Testing: `bun run test` - 305/305 tests passing
- Implementation fully completed, then reverted per Product decision

### Completion Notes List

**Story Cancelled - UX Issue Identified (2025-01-12)**

Implementation was successfully completed with all technical requirements met:
- ✅ Created TypeScript types for transition suggestions
- ✅ Implemented BFF API routes following security patterns
- ✅ Built TanStack Query hook with proper caching
- ✅ Created shadcn/ui dialog components with design tokens
- ✅ Integrated with context switcher
- ✅ All linting and tests passing

**Reason for Cancellation:**
Modal dialog approach fundamentally breaks user experience flow. When users are engaged in focused chat conversations with the AI, an interrupting modal for context switches disrupts concentration and kills the natural rhythm of interaction.

**Recommended Alternative Approach:**
Instead of a modal popup, implement **conversational context switch handling** within the chat AI itself:
- AI naturally notices context switch during conversation
- Provides gentle, contextual reminders: *"I see you've switched to Work context. Just a heads up - you have 3 urgent items in Personal context that need attention. Would you like me to help with those first?"*
- Keeps user in flow state
- Feels natural and helpful, not disruptive

**Action Items:**
- SM/PM should create new story for conversational context-switch awareness feature
- Consider backend API (Stories 4.2, 4.3) may still be useful for AI agent to query transition suggestions
- Recommend reviewing Epic 4 scope with Product Owner

### File List
All implementation files were removed after cancellation decision:
- `my_flow_client/src/types/transitions.ts` (deleted)
- `my_flow_client/src/app/api/transitions/suggestions/route.ts` (deleted)
- `my_flow_client/src/app/api/transitions/warnings/[context_id]/route.ts` (deleted)
- `my_flow_client/src/hooks/use-transition-suggestions.ts` (deleted)
- `my_flow_client/src/components/transitions/transition-suggestions.tsx` (deleted)
- `my_flow_client/src/components/transitions/urgent-flow-card.tsx` (deleted)
- All associated test files (deleted)
- Integration changes to `context-switcher.tsx` (reverted)

## QA Results

### Review Date
(To be populated by QA Agent)

### Reviewed By
(To be populated by QA Agent)

### Executive Summary
(To be populated by QA Agent)

