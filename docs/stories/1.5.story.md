# Story 1.5: CSS Tokens & Developer Experience (FRONTEND)

## Status
Draft

## Story
**As a** frontend developer,
**I want** all components migrated to CSS design tokens, toast notifications integrated, and types centralized,
**so that** the codebase is consistent, maintainable, and provides excellent developer experience.

## Acceptance Criteria

1. **CSS Design Tokens Developer Guide Created:**
   - Comprehensive guide document created at `docs/ux-design-tokens/css-tokens-usage.md`
   - Guide explains 3-layer token system (Primitive, Semantic, Component)
   - File locations documented (`src/app/styles/tokens/`)
   - Usage examples with before/after migration patterns
   - Instructions for using existing tokens and dynamic context theming
   - **CRITICAL:** No new tokens to be added unless approved by designer/UX expert
   - Reference added to `docs/architecture/coding-standards.md` pointing to this guide
   - **MUST BE COMPLETED FIRST** before any component migration

2. **All existing components migrated to CSS design tokens:**
   - Button component uses `--button-bg-*` tokens instead of hardcoded Tailwind colors
   - Navigation component uses `--color-context-*` tokens
   - Card components use `--card-*` tokens
   - All color references use CSS custom properties from `styles/tokens/colors.css`

3. **Sonner toast library integrated for notifications:**
   - `sonner` package installed and configured
   - Toast provider added to root layout
   - `showContextSwitchNotification()` function updated to use Sonner
   - Test notification fires when context switches

4. **Type exports centralized in `src/types/` directory:**
   - Create `src/types/context.ts` exporting: `ContextType`, `ContextSwitchConfig`, `AIContextSuggestion`
   - All components import types from centralized location, not individual lib files
   - IDE autocomplete works for all exported types

5. **JSDoc @example blocks added to key functions:**
   - `setContextTheme()` has usage example
   - `handleAIContextSuggestion()` has configuration example
   - `showContextSwitchNotification()` has Sonner integration example
   - All examples render in IDE tooltips (VSCode IntelliSense)

6. **CI/CD Work Status Documented:**
   - README updated noting that CI pipelines (Story 1.5 original scope) are 70% complete
   - Automated deployment workflows deferred to end of project
   - Existing workflows: `backend-ci.yml`, `frontend-ci.yml`, `ci.yml` documented

## Tasks / Subtasks

### Task 1: Create CSS Design Tokens Developer Guide (AC: 1) **[MUST COMPLETE FIRST]**
- [ ] Review existing implementation files to understand current system:
  - [ ] Read all token files in `my_flow_client/src/app/styles/tokens/` (colors.css, typography.css, spacing.css, effects.css, animation.css)
  - [ ] Read `my_flow_client/src/app/globals.css` to understand how tokens are imported with `@layer` syntax
  - [ ] Review `lib/context-theme.ts` to understand dynamic theming with `setContextTheme()`
  - [ ] Audit existing components to identify what needs migration
- [ ] Create directory: `docs/ux-design-tokens/`
- [ ] Create comprehensive guide: `docs/ux-design-tokens/css-tokens-usage.md` including:
  - [ ] 3-layer token system explanation (Primitive ‚Üí Semantic ‚Üí Component)
  - [ ] File locations and import structure (`@layer tokens` pattern)
  - [ ] Before/after migration examples (hardcoded Tailwind ‚Üí CSS tokens)
  - [ ] Dynamic context theming documentation (`setContextTheme()` usage)
  - [ ] **CRITICAL:** No new tokens to be added unless approved by designer/UX expert
  - [ ] Common migration patterns and pitfalls
- [ ] Update `docs/architecture/coding-standards.md`:
  - [ ] Add prominent reference to `docs/ux-design-tokens/css-tokens-usage.md`
  - [ ] Add new section or subsection under "Critical Fullstack Rules" or "Design Decisions"
  - [ ] Ensure all future devs will see this when reviewing coding standards

### Task 2: Audit and Migrate Components to CSS Tokens (AC: 2)
- [ ] Create detailed migration checklist based on Task 1 audit
- [ ] Update Button component to use `--button-bg-primary`, `--button-bg-secondary`, etc.
- [ ] Update Navigation component to use `--color-context-current`
- [ ] Update all Card-based components to use `--card-bg`, `--card-border`
- [ ] Remove all direct Tailwind color classes (`bg-blue-500` ‚Üí `bg-[var(--button-bg-primary)]`)
- [ ] Test components in all 4 contexts (work, personal, rest, social)

### Task 3: Integrate Sonner Toast Library (AC: 3)
- [ ] Install Sonner: `bun add sonner`
- [ ] Add `<Toaster />` component to `app/layout.tsx` (after ContextProvider)
- [ ] Update `showContextSwitchNotification()` in `lib/ai-context-handler.ts` to use `toast.info()`
- [ ] Test toast notification displays when context switches
- [ ] Configure toast duration, position, and styling to match design tokens
- [ ] Add toast for other user actions (flow created, flow completed, etc.)

### Task 4: Centralize Type Exports (AC: 4)
- [ ] Create `src/types/context.ts` file
- [ ] Export `ContextType` from `lib/context-theme.ts` via central file
- [ ] Export `ContextSwitchConfig`, `AIContextSuggestion` from `lib/ai-context-handler.ts`
- [ ] Update all component imports to use `@/types/context` instead of direct lib imports
- [ ] Verify IDE autocomplete works (test in VSCode with `Ctrl+Space`)
- [ ] Remove duplicate type definitions if found

### Task 5: Add JSDoc @example Documentation (AC: 5)
- [ ] Add JSDoc with @example to `setContextTheme()` in `lib/context-theme.ts`
- [ ] Add JSDoc with @example to `handleAIContextSuggestion()` in `lib/ai-context-handler.ts`
- [ ] Add JSDoc with @example to `showContextSwitchNotification()` showing Sonner usage
- [ ] Add JSDoc to centralized type exports in `src/types/context.ts`
- [ ] Verify examples render in IDE tooltips (VSCode IntelliSense on hover)
- [ ] Test that examples are executable (copy-paste works)

### Task 6: Document CI/CD Status and Deployment Deferral (AC: 6)
- [ ] Update root `README.md` with CI/CD status section
- [ ] Document existing workflows: `backend-ci.yml`, `frontend-ci.yml`, `ci.yml`
- [ ] Add note that CI pipelines are complete (Story 1.5 original scope 70% done)
- [ ] Add note that automated deployment workflows (`.github/workflows/deploy.yml`) deferred to end of project
- [ ] Add links to Vercel and Railway/Render deployment documentation
- [ ] Update `.github/workflows/README.md` if it exists

### Task 7: Write Unit Tests for Migrated Components
- [ ] Test Button component renders with CSS token colors in all variants
- [ ] Test Navigation component updates `--color-context-current` on context switch
- [ ] Test Sonner toast appears with correct message on context switch
- [ ] Mock Sonner in tests to verify `toast.info()` called with correct params
- [ ] Verify all components pass existing tests after token migration

### Task 8: Update Frontend Documentation
- [ ] Update `my_flow_client/README.md` with CSS token migration notes
- [ ] Document Sonner toast usage patterns for future features
- [ ] Document centralized type export pattern for new types
- [ ] Add JSDoc examples to developer onboarding guide

## Dev Notes

### Tech Stack Details

**Frontend Framework:**
- **Next.js:** 15.x with App Router (React Server Components)
- **React:** 18.x+ (Server + Client Components)
- **TypeScript:** 5.x+ strict mode
- **Tailwind CSS:** 4.x with CSS custom properties
- **Sonner:** Toast notification library (to be added)
- **Source:** docs/architecture/tech-stack.md:13-16

**CSS Design Tokens Implementation:**
- **Token Files:** Layered in `src/app/styles/tokens/` (colors, typography, spacing, effects, animation)
- **Import Order:** `globals.css` ‚Üí `@layer tokens` ‚Üí individual token files
- **Dynamic Theming:** `setContextTheme()` updates `--color-context-current` at runtime
- **Source:** docs/architecture/frontend-architecture.md:250-373

### Project Structure and File Locations

**Frontend Directory Structure:**
```
my_flow_client/
‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îú‚îÄ‚îÄ app/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ layout.tsx             # Root layout (add Toaster here)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ globals.css            # CSS token imports
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ styles/
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ tokens/            # Design token definitions
‚îÇ   ‚îÇ           ‚îú‚îÄ‚îÄ colors.css     # Color tokens (3-layer system)
‚îÇ   ‚îÇ           ‚îú‚îÄ‚îÄ typography.css # Font and text tokens
‚îÇ   ‚îÇ           ‚îú‚îÄ‚îÄ spacing.css    # Spacing scale tokens
‚îÇ   ‚îÇ           ‚îú‚îÄ‚îÄ effects.css    # Shadow and blur tokens
‚îÇ   ‚îÇ           ‚îî‚îÄ‚îÄ animation.css  # Animation duration/easing
‚îÇ   ‚îú‚îÄ‚îÄ components/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ ui/                    # shadcn/ui components (migrate these)
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ button.tsx
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ card.tsx
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ ... (other UI components)
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ navigation.tsx         # Site navigation (uses context colors)
‚îÇ   ‚îú‚îÄ‚îÄ lib/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ context-theme.ts       # Context theme management
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ ai-context-handler.ts  # AI context switching logic
‚îÇ   ‚îú‚îÄ‚îÄ types/                     # Centralized type exports (CREATE THIS)
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ context.ts             # Context-related types (CREATE THIS)
‚îÇ   ‚îî‚îÄ‚îÄ hooks/
‚îÇ       ‚îî‚îÄ‚îÄ use-context-theme.ts   # Hook for context theme
```
**Source:** docs/architecture/source-tree.md:25-65

### CSS Design Tokens Pattern

**Three-Layer Token System:**
1. **Primitive Colors** (Layer 1): Raw color values (`--primitive-work`, `--primitive-black-900`)
2. **Semantic Colors** (Layer 2): Purpose-driven (`--color-bg-primary`, `--color-text-primary`)
3. **Component Colors** (Layer 3): Component-specific (`--button-bg-primary`, `--card-bg`)

**Current Implementation:**
```css
/* colors.css - Already exists with full 3-layer system */
:root {
  /* Primitive Colors */
  --primitive-work: #3b82f6;
  --primitive-work-hover: #60a5fa;
  --primitive-work-active: #93c5fd;

  /* Semantic Colors */
  --color-context-current: var(--primitive-work); /* Dynamic via JS */
  --color-bg-primary: var(--primitive-black-900);
  --color-text-primary: var(--primitive-white);

  /* Component Colors */
  --button-bg-primary: var(--color-context-current);
  --button-bg-primary-hover: var(--color-context-current-hover);
  --card-bg: var(--color-bg-secondary);
  --card-border: var(--color-border);
}
```
**Source:** my_flow_client/src/app/styles/tokens/colors.css:1-130

**Migration Pattern for Components:**
```tsx
// ‚ùå BEFORE: Hardcoded Tailwind colors
<button className="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded">
  Create Flow
</button>

// ‚úÖ AFTER: CSS design tokens
<button className="bg-[var(--button-bg-primary)] hover:bg-[var(--button-bg-primary-hover)] text-[var(--button-text-primary)] px-4 py-2 rounded">
  Create Flow
</button>

// OR use Tailwind v4 @apply pattern (if configured):
.btn-primary {
  @apply bg-[var(--button-bg-primary)] hover:bg-[var(--button-bg-primary-hover)];
}
```

### Sonner Toast Integration Pattern

**Installation and Setup:**
```bash
bun add sonner
```

**Root Layout Integration:**
```tsx
// app/layout.tsx
import { Toaster } from 'sonner';
import { ContextProvider } from '@/components/context-provider';

export default function RootLayout({ children }: { children: React.ReactNode }) {
  return (
    <html lang="en">
      <body>
        <ContextProvider>
          {children}
          <Toaster
            position="top-right"
            theme="dark"
            toastOptions={{
              style: {
                background: 'var(--color-bg-secondary)',
                color: 'var(--color-text-primary)',
                border: '1px solid var(--color-border)',
              },
            }}
          />
        </ContextProvider>
      </body>
    </html>
  );
}
```

**Notification Function Update:**
```typescript
// lib/ai-context-handler.ts
import { toast } from 'sonner';

/**
 * Display AI context switch notification using Sonner toast library
 *
 * @example
 * showContextSwitchNotification('work', 'personal', 'Detected personal calendar mention');
 * // Shows: "Switched to personal context"
 * // Description: "Detected personal calendar mention"
 */
export function showContextSwitchNotification(
  fromContext: ContextType,
  toContext: ContextType,
  reason?: string
): void {
  toast.info(`Switched to ${toContext} context`, {
    description: reason || `Detected ${toContext}-related activity`,
    duration: 3000,
  });
}
```
**Source:** User requirement (repurposed Story 1.5)

### Type Centralization Pattern

**Central Type Export File:**
```typescript
// src/types/context.ts
/**
 * Central export file for all context-related types.
 * Import from here instead of individual lib files for better discoverability.
 *
 * @example
 * import { ContextType, ContextSwitchConfig } from '@/types/context';
 *
 * const config: ContextSwitchConfig = {
 *   mode: 'suggest',
 *   suggestThreshold: 0.8,
 * };
 */

// Re-export from lib/context-theme.ts
export type { ContextType } from '@/lib/context-theme';

// Re-export from lib/ai-context-handler.ts
export type { ContextSwitchConfig } from '@/lib/ai-context-handler';

// Re-export from types/ai-context.ts (if exists)
export type { AIContextSuggestion } from '@/types/ai-context';
```

**Component Import Update:**
```typescript
// ‚ùå BEFORE: Direct imports from multiple files
import type { ContextType } from '@/lib/context-theme';
import type { ContextSwitchConfig } from '@/lib/ai-context-handler';

// ‚úÖ AFTER: Single import from centralized types
import type { ContextType, ContextSwitchConfig } from '@/types/context';
```
**Source:** User requirement (repurposed Story 1.5)

### JSDoc @example Pattern

**Function Documentation with Examples:**
```typescript
/**
 * Sets the active context theme by updating CSS custom properties
 *
 * @param context - The context type to activate
 *
 * @example
 * // Switch to work context (blue theme)
 * setContextTheme('work');
 *
 * @example
 * // Switch to personal context (orange theme)
 * setContextTheme('personal');
 */
export function setContextTheme(context: ContextType): void {
  // ... implementation
}

/**
 * Handles AI-triggered context switches based on user preferences
 *
 * @param suggestion - AI context suggestion from chat response
 * @param config - Context switch configuration including mode and thresholds
 * @param currentContext - Current active context
 * @returns Whether to proceed with context switch
 *
 * @example
 * const suggestion: AIContextSuggestion = {
 *   suggestedContext: 'personal',
 *   confidence: 0.9,
 *   reason: 'Detected personal calendar mention',
 * };
 *
 * const config: ContextSwitchConfig = {
 *   mode: 'suggest',
 *   suggestThreshold: 0.8,
 * };
 *
 * const switched = handleAIContextSuggestion(suggestion, config, 'work');
 * // Returns true, switches to 'personal' context
 */
export function handleAIContextSuggestion(
  suggestion: AIContextSuggestion,
  config: ContextSwitchConfig,
  currentContext: ContextType
): boolean {
  // ... implementation
}
```
**Source:** User requirement (repurposed Story 1.5)

### Testing Requirements

**Unit Tests (Vitest):**
- **Location:** `my_flow_client/src/components/__tests__/`
- **Framework:** Vitest with React Testing Library
- **Coverage Threshold:** 70% minimum for frontend
- **Source:** docs/architecture/13-testing-strategy.md

**Component Testing Example:**
```typescript
import { render, screen } from '@testing-library/react';
import { Button } from '@/components/ui/button';

describe('Button Component', () => {
  it('renders with CSS token colors', () => {
    render(<Button variant="primary">Click me</Button>);

    const button = screen.getByRole('button');
    const styles = window.getComputedStyle(button);

    // Verify button uses CSS token for background
    expect(styles.backgroundColor).toBe('var(--button-bg-primary)');
  });

  it('applies hover styles using CSS tokens', () => {
    render(<Button variant="primary">Hover me</Button>);

    const button = screen.getByRole('button');

    // Verify hover class uses token
    expect(button.className).toContain('hover:bg-[var(--button-bg-primary-hover)]');
  });
});
```

**Toast Testing Example:**
```typescript
import { render } from '@testing-library/react';
import { toast } from 'sonner';
import { showContextSwitchNotification } from '@/lib/ai-context-handler';

vi.mock('sonner', () => ({
  toast: {
    info: vi.fn(),
  },
}));

describe('Context Switch Notification', () => {
  it('calls toast.info with correct message', () => {
    showContextSwitchNotification('work', 'personal', 'Detected personal task');

    expect(toast.info).toHaveBeenCalledWith(
      'Switched to personal context',
      {
        description: 'Detected personal task',
        duration: 3000,
      }
    );
  });
});
```

### CI/CD Status Documentation

**Original Story 1.5 Scope (Epic 1):**
Story 1.5 originally covered CI/CD pipeline setup with GitHub Actions. This work is **70% complete** with the following status:

**‚úÖ Completed:**
1. Backend CI Workflow (`.github/workflows/backend-ci.yml`)
   - Linting with ruff
   - Type checking with mypy
   - Unit tests with pytest
   - Coverage reporting
2. Frontend CI Workflow (`.github/workflows/frontend-ci.yml`)
   - Linting with ESLint
   - Type checking with TypeScript
   - Unit tests with Vitest
   - Build verification
   - Logto secret verification
3. Full-Stack CI Workflow (`.github/workflows/ci.yml`)
   - Combines backend and frontend CI
   - Status check job for PR requirements

**üöß Deferred to End of Project:**
1. CI status badges in README.md
2. Deployment workflow (`.github/workflows/deploy.yml`)
   - Vercel frontend deployment
   - Railway/Render backend deployment
3. 1Password service account integration in GitHub Actions

**Rationale for Deferral:**
- CI pipelines are sufficient for current development phase
- Deployment automation can be added post-MVP once hosting platforms finalized
- Allows focus on core feature development in Epic 2 and Epic 3

**Source:** User decision (conversation context)

### Coding Standards for Frontend

**File Naming Conventions:**
- **React Components:** PascalCase for component files (`Button.tsx`, `FlowCard.tsx`)
- **Hooks:** camelCase with `use` prefix (`useContextTheme.ts`, `useFlows.ts`)
- **Utils/Libs:** kebab-case (`api-client.ts`, `context-theme.ts`)
- **Types:** kebab-case (`context.ts`, `api.ts`)
- **Source:** docs/architecture/coding-standards.md:178-197

**Import Order Standards:**
```typescript
// 1. External dependencies
import { useState, useEffect } from 'react';
import { toast } from 'sonner';

// 2. Internal absolute imports (@/ alias)
import { Button } from '@/components/ui/button';
import type { ContextType } from '@/types/context';

// 3. Relative imports
import { FlowCard } from './flow-card';

// 4. Styles (if any)
import './styles.css';
```
**Source:** docs/architecture/coding-standards.md:242-260

## Testing

### Unit Tests

**Test Framework:** Vitest with React Testing Library
- **Location:** `my_flow_client/src/components/__tests__/`
- **Files:**
  - `button.test.tsx` - Test CSS token usage in Button variants
  - `navigation.test.tsx` - Test context color updates in Navigation
  - `ai-context-handler.test.ts` - Test Sonner toast integration
- **Coverage Threshold:** 70% (statements, branches, functions, lines)
- **Run Command:** `bun test`
- **Coverage Command:** `bun test --coverage`

**Key Test Scenarios:**
1. Button renders with `--button-bg-primary` token in primary variant
2. Navigation updates `--color-context-current` when context switches
3. Toast notification fires with correct message on context switch
4. Centralized type imports resolve correctly in components
5. JSDoc examples render in IDE tooltips

### Manual QA

**Prerequisites:**
- Frontend running: `bun dev` (http://localhost:3000)
- Browser DevTools open to inspect CSS custom properties

**QA Steps:**
1. **CSS Token Migration:**
   - Navigate to `/dashboard` and inspect Button component
   - Verify computed styles show `background-color: var(--button-bg-primary)`
   - Switch context from Work to Personal
   - Verify button color changes from blue (#3b82f6) to orange (#f97316)

2. **Sonner Toast Integration:**
   - Trigger context switch (manual or via AI suggestion)
   - Verify toast appears in top-right corner with message "Switched to X context"
   - Verify toast auto-dismisses after 3 seconds
   - Check toast uses design token colors (dark background, white text)

3. **Type Centralization:**
   - Open VSCode and create new component file
   - Type `import { ContextType } from '@/types/context'`
   - Verify IDE autocomplete suggests `ContextType`, `ContextSwitchConfig`, `AIContextSuggestion`
   - Hover over imported type and verify JSDoc shows in tooltip

4. **JSDoc Examples:**
   - Open `lib/context-theme.ts` in VSCode
   - Hover over `setContextTheme()` function
   - Verify tooltip shows `@example` blocks with usage examples
   - Copy-paste example code and verify it executes without errors

**Type Checking:**
- Run `bun run type-check` ‚Üí verify no type errors

**Linting:**
- Run `bun run lint` ‚Üí verify no linting errors

## Change Log

| Date | Author | Change Description | Story Status |
|------|--------|-------------------|--------------|
| 2025-10-05 | Scrum Master (Bob) | Initial story creation (repurposed from Epic 1.5 CI/CD) | Draft |
| 2025-10-05 | Scrum Master (Bob) | Scope changed to CSS tokens, Sonner, types, JSDoc (frontend-only) | Draft |

## Dev Agent Record

*(This section will be populated by the development agent during implementation)*

### Agent Model Used

*(To be filled by Dev Agent)*

### Debug Log References

*(To be filled by Dev Agent)*

### Completion Notes List

*(To be filled by Dev Agent)*

### File List

*(To be filled by Dev Agent)*

## QA Results

*(This section will be populated after QA review)*
